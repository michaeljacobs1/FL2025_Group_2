{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Information - {{ user.username }}</title>
    <link rel="stylesheet" href="{% static 'styles.css' %}">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-brand">Financial Planner</h1>
            <div class="nav-links">
                <a href="{% url 'financial_dashboard' %}" class="nav-link">Dashboard</a>
                <a href="{% url 'personal_info' %}" class="nav-link">Personal Info</a>
                <a href="{% url 'financial_info' %}" class="nav-link active">Financial Info</a>
                <a href="{% url 'results' %}" class="nav-link">Results</a>
                <form method="post" action="{% url 'logout' %}" class="logout-form">
                    {% csrf_token %}
                    <button type="submit" class="logout-btn">Logout</button>
                </form>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <div class="page-header">
                <h2>Financial Information</h2>
                <p>Provide your current financial situation to enable accurate projections.</p>
            </div>

            {% if messages %}
                <div class="messages">
                    {% for message in messages %}
                        <div class="message message-{{ message.tags }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}

            <div class="financial-sections">
                <div class="card form-card">
                    <div class="card-header">
                        <h3>Income Timeline (By Year)</h3>
                        <div class="form-toolbar">
                            <span class="pill">Manual or Growth-based</span>
                        </div>
                    </div>

                    <div class="card-content">
                        <form method="post" id="yearlyForm" class="pretty-form">
                            {% csrf_token %}
                            <input type="hidden" name="income_mode" value="by_year">

                            <div class="form-grid">
                                <div class="field">
                                    <label for="startYear">Start Year</label>
                                    <input class="input" id="startYear" type="number" value="{{ income_entries.0.year|default:2025 }}" min="1900" max="2200">
                                </div>
                                <div class="field">
                                    <label for="yearsCount"># Years</label>
                                    <input class="input" id="yearsCount" type="number" value="{{ income_entries|length|default:5 }}" min="1" max="200">
                                </div>
                                <div class="field">
                                    <label for="baseIncome">Base Income</label>
                                    <input class="input" id="baseIncome" type="number" step="0.01" placeholder="e.g. 50000">
                                </div>
                                <div class="field">
                                    <label for="growthPct">Income growth %</label>
                                    <input class="input" id="growthPct" type="number" step="0.01" placeholder="e.g. 3">
                                </div>
                            </div>

                            <div class="form-grid">
                                <div class="field">
                                    <label for="baseSavings">Base savings rate %</label>
                                    <input class="input" id="baseSavings" type="number" step="0.01" min="0" max="100" placeholder="e.g. 15">
                                </div>
                                <div class="field">
                                    <label for="savingsGrowth">Savings rate growth %</label>
                                    <input class="input" id="savingsGrowth" type="number" step="0.01" min="0" max="100" placeholder="e.g. 1">
                                </div>
                                <div class="field" style="align-self:end;">
                                    <label class="checkbox-inline">
                                        <input type="checkbox" id="useConstantRate" name="use_constant_rate" value="1">
                                        Keep savings rate constant
                                    </label>
                                </div>
                                <input type="hidden" id="constantRate" name="constant_rate_value">
                            </div>

                            <div class="form-grid form-grid--inline">
                                <div></div>
                                <div class="toolbar-actions">
                                    <button type="button" id="generateRows" class="btn-primary">Generate</button>
                                    <button type="button" id="addRow" class="btn-secondary">+ Row</button>
                                </div>
                            </div>

                            <div class="table-container">
                                <table class="projection-table pretty-table" id="incomeTable">
                                    <thead>
                                        <tr>
                                            <th style="width:140px;">Year</th>
                                            <th>Income (yearly)</th>
                                            <th>Savings Rate %</th>
                                            <th style="width:100px;"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if income_entries %}
                                            {% for r in income_entries %}
                                            <tr>
                                                <td><input class="cell-input" name="year[]" type="number" value="{{ r.year }}" min="1900" max="2200" required></td>
                                                <td><input class="cell-input" name="income[]" type="number" step="0.01" min="0" value="{{ r.income_amount }}" required></td>
                                                <td><input class="cell-input" name="savings_rate_year[]" type="number" step="0.01" min="0" max="100" value="{{ r.savings_rate|default:'' }}"></td>
                                                <td><button type="button" class="btn-danger remove-row">Remove</button></td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td><input class="cell-input" name="year[]" type="number" value="2025" min="1900" max="2200" required></td>
                                                <td><input class="cell-input" name="income[]" type="number" step="0.01" min="0" placeholder="0.00" required></td>
                                                <td><input class="cell-input" name="savings_rate_year[]" type="number" step="0.01" min="0" max="100" placeholder="0"></td>
                                                <td><button type="button" class="btn-danger remove-row">Remove</button></td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn-primary">Save</button>
                                <button type="submit" name="go_results" value="1" class="btn-secondary">Save & View Projections</button>
                            </div>
                        </form>

                        <div class="info-box">
                            <p><strong>Tips:</strong> “Generate” builds N rows from Start Year. If Base Income and <em>Income growth %</em> are provided, incomes compound from Base Income. To auto-fill savings rates, set a base rate and either keep it constant or provide a <em>Savings rate growth %</em>.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="next-steps">
                <h3>Next Steps</h3>
                <div class="action-buttons">
                    <a href="{% url 'results' %}" class="btn-secondary">View Projections</a>
                </div>
            </div>
        </div>
    </main>

    <script>
    (function(){
      const tbody = document.querySelector("#incomeTable tbody");
      const addRowBtn = document.getElementById("addRow");
      const genBtn = document.getElementById("generateRows");
      const startYearEl = document.getElementById("startYear");
      const yearsCountEl = document.getElementById("yearsCount");
      const growthEl = document.getElementById("growthPct");
      const baseIncomeEl = document.getElementById("baseIncome");

      const baseSavingsEl = document.getElementById("baseSavings");
      const savingsGrowthEl = document.getElementById("savingsGrowth");
      const useConstEl = document.getElementById("useConstantRate");
      const constRateHidden = document.getElementById("constantRate");

      useConstEl.addEventListener("change", ()=>{
        if(useConstEl.checked){
          constRateHidden.value = baseSavingsEl.value || "";
        }else{
          constRateHidden.value = "";
        }
      });
      baseSavingsEl.addEventListener("input", ()=>{
        if(useConstEl.checked){
          constRateHidden.value = baseSavingsEl.value || "";
        }
      });

      function addRow(y, inc, rate){
        const tr = document.createElement("tr");
        tr.innerHTML =
            '<td><input class="cell-input" name="year[]" type="number" min="1900" max="2200" required></td>'
          + '<td><input class="cell-input" name="income[]" type="number" step="0.01" min="0" required></td>'
          + '<td><input class="cell-input" name="savings_rate_year[]" type="number" step="0.01" min="0" max="100"></td>'
          + '<td><button type="button" class="btn-danger remove-row">Remove</button></td>';
        tbody.appendChild(tr);
        if (y !== undefined) tr.querySelector('input[name="year[]"]').value = y;
        if (inc !== undefined) tr.querySelector('input[name="income[]"]').value = inc;
        if (rate !== undefined && rate !== null && rate !== "") tr.querySelector('input[name="savings_rate_year[]"]').value = rate;
      }

      tbody.addEventListener("click", (e)=>{
        if(e.target.classList.contains("remove-row")){
          e.target.closest("tr").remove();
        }
      });

      addRowBtn.addEventListener("click", ()=> addRow());

      genBtn.addEventListener("click", ()=>{
        const start = parseInt(startYearEl.value || "2025", 10);
        const n = Math.max(1, Math.min(parseInt(yearsCountEl.value || "5", 10), 200));
        const incomeGrowth = parseFloat(growthEl.value || "");
        const baseIncome = parseFloat(baseIncomeEl.value || "");

        const baseSavings = parseFloat(baseSavingsEl.value || "");
        const savingsGrowth = parseFloat(savingsGrowthEl.value || "");
        const keepConst = !!useConstEl.checked;

        const rows = [];
        for(let i=0;i<n;i++){
          const yr = start + i;

          let inc = "";
          if(!isNaN(baseIncome) && !isNaN(incomeGrowth)){
            inc = (baseIncome * Math.pow(1 + (incomeGrowth/100), i)).toFixed(2);
          } else if(!isNaN(baseIncome) && isNaN(incomeGrowth)){
            inc = baseIncome.toFixed(2);
          }

          let rate = "";
          if(!isNaN(baseSavings)){
            if(keepConst){
              rate = baseSavings.toFixed(2);
            }else if(!isNaN(savingsGrowth)){
              rate = (baseSavings * Math.pow(1 + (savingsGrowth/100), i)).toFixed(2);
            }else{
              rate = baseSavings.toFixed(2);
            }
          }

          rows.push({year: yr, income: inc, rate});
        }

        tbody.innerHTML = "";
        rows.forEach(r => addRow(String(r.year), r.income, r.rate));
      });
    })();
    </script>
</body>
</html>
