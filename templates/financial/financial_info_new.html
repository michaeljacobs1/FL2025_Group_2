{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Information - {{ user.username }}</title>
    <link rel="stylesheet" href="{% static 'styles.css' %}">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-brand">Financial Planner</h1>
            <div class="nav-links">
                <a href="{% url 'financial_dashboard' %}" class="nav-link">Dashboard</a>
                <a href="{% url 'personal_info' %}" class="nav-link">Personal Info</a>
                <a href="{% url 'financial_info' %}" class="nav-link active">Financial Info</a>
                <a href="{% url 'results' %}" class="nav-link">Results</a>
                <form method="post" action="{% url 'logout' %}" class="logout-form">
                    {% csrf_token %}
                    <button type="submit" class="logout-btn">Logout</button>
                </form>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <div class="page-header">
                <h2>Financial Planning</h2>
                <p>Plan your financial future using Cost-of-Living indexes by state and your spending preferences.</p>
            </div>

            {% if messages %}
                <div class="messages">
                    {% for message in messages %}
                        <div class="message message-{{ message.tags }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}

            <div class="financial-sections">
                <!-- Combined Card with Step 1 and Step 2 -->
                <div class="card form-card step-card">
                    <!-- Step 1: Income Projection -->
                    <div class="step-section step-section-1">
                        <div class="card-header">
                            <div class="step-indicator">
                                <span class="step-number">Step 1</span>
                                <h3>Income Projection</h3>
                            </div>
                        </div>

                        <div class="card-content">
                            <form method="post" id="incomeForm" class="pretty-form">
                                {% csrf_token %}
                                <input type="hidden" name="income_mode" value="by_year">
                                
                                <div class="form-grid">
                                    <div class="field">
                                        <label for="startYear">Start Year</label>
                                        <input class="input" id="startYear" type="number" min="1900" max="2200" required>
                                    </div>
                                    <div class="field">
                                        <label for="yearsCount">Total Years to Project</label>
                                        <input class="input" id="yearsCount" type="number" min="1" max="100" required>
                                    </div>
                                </div>

                                <div class="form-grid">
                                    <div class="field">
                                        <label for="baseIncome">Starting Income ($)</label>
                                        <input class="input" id="baseIncome" type="number" step="0.01" placeholder="e.g. 100000" required>
                                    </div>
                                    <div class="field">
                                        <label for="growthPct">Annual Income Growth (%)</label>
                                        <input class="input" id="growthPct" type="number" step="0.01" placeholder="e.g. 5" required>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Step Divider -->
                    <div class="step-divider"></div>

                    <!-- Step 2: Location & Spending Preferences -->
                    <div class="step-section step-section-2">
                        <div class="card-header">
                            <div class="step-indicator">
                                <span class="step-number">Step 2</span>
                                <h3>Location &amp; Spending Preferences</h3>
                            </div>
                        </div>

                        <div class="card-content">
                        <form method="post" id="locationSpendingForm" class="pretty-form">
                            {% csrf_token %}
                            
                            <!-- Location Section -->
                            <div class="section-header">
                                <h4>Where Will You Live?</h4>
                                <p class="section-description">Add locations and specify how many years you'll live in each place</p>
                            </div>

                            <div id="locationContainer"></div>
                            
                            <div class="location-controls">
                                <button type="button" id="addLocation" class="btn-secondary">
                                    <i class="fas fa-plus"></i> Add Another Location
                                </button>
                                <div class="year-validation" id="yearValidation">
                                    <span class="validation-text">Total years: <span id="totalYears">0</span> / <span id="requiredYears">0</span></span>
                                    <span class="validation-status" id="validationStatus"></span>
                                </div>
                            </div>

                            <!-- Spending Preferences Section -->
                            <div class="section-header">
                                <h4>Spending Preferences</h4>
                                <p class="section-description">Rate your spending habits for each category</p>
                            </div>

                            <div class="form-grid">
                                <div class="field">
                                    <label for="housing_spending">Housing Spending</label>
                                    <select class="input" id="housing_spending" name="housing_spending" required>
                                        <option value="very_little">Very Little</option>
                                        <option value="less_than_average">Less Than Average</option>
                                        <option value="average" selected>Average</option>
                                        <option value="above_average">Above Average</option>
                                        <option value="very_high">Very High</option>
                                    </select>
                                </div>
                                <div class="field">
                                    <label for="travel_spending">Travel Spending</label>
                                    <select class="input" id="travel_spending" name="travel_spending" required>
                                        <option value="very_little">Very Little</option>
                                        <option value="less_than_average">Less Than Average</option>
                                        <option value="average" selected>Average</option>
                                        <option value="above_average">Above Average</option>
                                        <option value="very_high">Very High</option>
                                    </select>
                                </div>
                                <div class="field">
                                    <label for="food_spending">Food & Groceries</label>
                                    <select class="input" id="food_spending" name="food_spending" required>
                                        <option value="very_little">Very Little</option>
                                        <option value="less_than_average">Less Than Average</option>
                                        <option value="average" selected>Average</option>
                                        <option value="above_average">Above Average</option>
                                        <option value="very_high">Very High</option>
                                    </select>
                                </div>
                                <div class="field">
                                    <label for="leisure_spending">Leisure Spending</label>
                                    <select class="input" id="leisure_spending" name="leisure_spending" required>
                                        <option value="very_little">Very Little</option>
                                        <option value="less_than_average">Less Than Average</option>
                                        <option value="average" selected>Average</option>
                                        <option value="above_average">Above Average</option>
                                        <option value="very_high">Very High</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="button" id="generateResults" class="btn-primary">
                                    Generate Results
                                </button>
                            </div>
                        </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Table Section - Below Step 1 and Step 2 -->
            <div class="card form-card" id="resultsTableSection" style="display: none;">
                <div class="card-header">
                    <h3>Annual Income & Costs</h3>
                    <div class="form-toolbar">
                        <button type="button" id="saveEditsBtn" class="btn-primary">Save Changes</button>
                    </div>
                </div>
                <div class="card-content">
                    <p class="section-description">Review and edit your annual income and costs. Values are auto-populated from Step 1 and Step 2.</p>
                    <div class="table-container">
                        <table class="table" id="resultsTable">
                            <colgroup>
                                <col style="width: 16.6667%;">
                                <col style="width: 16.6667%;">
                                <col style="width: 16.6667%;">
                                <col style="width: 16.6667%;">
                                <col style="width: 16.6667%;">
                                <col style="width: 16.6667%;">
                            </colgroup>
                            <thead>
                                <tr>
                                    <th>Year</th>
                                    <th>Location</th>
                                    <th>Income ($)</th>
                                    <th>Costs ($)</th>
                                    <th>After-Tax Income ($)</th>
                                    <th>Net Savings ($)</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    {% if location_preferences %}
        {{ location_preferences|json_script:"saved-locations" }}
    {% endif %}

    <script>
    // Global variables
    let incomeData = [];
    let locationData = [];
    let totalProjectionYears = 0;
    let startYear = 2025;

    // DOM elements
    const startYearEl = document.getElementById('startYear');
    const yearsCountEl = document.getElementById('yearsCount');
    const baseIncomeEl = document.getElementById('baseIncome');
    const growthEl = document.getElementById('growthPct');
    const locationContainer = document.getElementById('locationContainer');
    const addLocationBtn = document.getElementById('addLocation');
    const generateCostsBtn = document.getElementById('generateResults');
    const resultsSection = document.getElementById('resultsSection');
    const resultsTableBody = document.getElementById('resultsTableBody');

    // State options for dropdown
    const STATES = [
        "West Virginia","Oklahoma","Kansas","Mississippi","Alabama","Arkansas","Missouri","Iowa","Michigan","Indiana","Tennessee","Georgia","North Dakota","Louisiana","South Dakota","Texas","Kentucky","Nebraska","New Mexico","Ohio","Illinois","Montana","Minnesota","Pennsylvania","Wyoming","South Carolina","Wisconsin","North Carolina","Virginia","Delaware","Nevada","Colorado","Idaho","Florida","Utah","Arizona","Oregon","Maine","Rhode Island","Connecticut","New Hampshire","Washington","Vermont","New Jersey","Maryland","New York","Alaska","District of Columbia","California","Massachusetts","Hawaii"
    ];

    const AREA_LEVELS = [
        { value: 'very_low', label: 'Very Low' },
        { value: 'less_than_average', label: 'Less Than Average' },
        { value: 'average', label: 'Average' },
        { value: 'above_average', label: 'Above Average' },
        { value: 'very_high', label: 'Very High' }
    ];

    // Load saved form data from database (passed from server)
    function loadSavedDataFromDatabase() {
        // Check if has_saved_data flag is set to true
        {% if has_saved_data %}
            // Load income data if available
            {% if income_data %}
                startYearEl.value = {{ income_data.startYear }};
                yearsCountEl.value = {{ income_data.totalYears }};
                baseIncomeEl.value = {{ income_data.startingIncome }};
                growthEl.value = {{ income_data.growthRate|floatformat:2 }};
            {% endif %}
            
            // Load spending preferences if available
            {% if spending_preference %}
                document.getElementById('housing_spending').value = '{{ spending_preference.housing_spending }}';
                document.getElementById('travel_spending').value = '{{ spending_preference.travel_spending }}';
                document.getElementById('food_spending').value = '{{ spending_preference.food_spending }}';
                document.getElementById('leisure_spending').value = '{{ spending_preference.leisure_spending }}';
            {% endif %}
            
            // Load locations if available
            const savedLocationsEl = document.getElementById('saved-locations');
            if (savedLocationsEl) {
                locationContainer.innerHTML = '';
                const savedLocations = JSON.parse(savedLocationsEl.textContent);
                savedLocations.forEach((loc) => {
                    addLocationRow();
                    const stateSelects = document.querySelectorAll('select[name="state[]"]');
                    const areaSelects = document.querySelectorAll('select[name="area_level[]"]');
                    const yearInputs = document.querySelectorAll('input[name="location_years[]"]');
                    const lastIndex = stateSelects.length - 1;
                    if (stateSelects[lastIndex]) {
                        stateSelects[lastIndex].value = loc.state;
                        areaSelects[lastIndex].value = loc.areaLevel;
                        // Calculate years from start and end year
                        const years = loc.endYear - loc.startYear + 1;
                        yearInputs[lastIndex].value = years;
                    }
                });
            }
            
            updateYearValidation();
        {% endif %}
    }

    // Save form data
    function saveFormData() {
        const stateSelects = document.querySelectorAll('select[name="state[]"]');
        const areaSelects = document.querySelectorAll('select[name="area_level[]"]');
        const yearInputs = document.querySelectorAll('input[name="location_years[]"]');
        const locations = [];
        
        for (let i = 0; i < stateSelects.length; i++) {
            if (stateSelects[i].value.trim()) {
                locations.push({
                    state: stateSelects[i].value.trim(),
                    areaLevel: areaSelects[i].value,
                    years: parseInt(yearInputs[i].value) || 0
                });
            }
        }
        
        const formData = {
            startYear: startYearEl.value,
            yearsCount: yearsCountEl.value,
            baseIncome: baseIncomeEl.value,
            growthPct: growthEl.value,
            housingSpending: document.getElementById('housing_spending').value,
            travelSpending: document.getElementById('travel_spending').value,
            foodSpending: document.getElementById('food_spending').value,
            leisureSpending: document.getElementById('leisure_spending').value,
            locations: locations
        };
        
        localStorage.setItem('financialFormData', JSON.stringify(formData));
    }

    // Step 2: Location Management
    function addLocationRow() {
        const row = document.createElement('div');
        row.className = 'location-row';
        row.innerHTML = `
            <div class="form-grid">
                <div class="field">
                    <label>State</label>
                    <select class="input" name="state[]" required>
                        <option value="">Select State</option>
                        ${STATES.map(s => `<option value="${s}">${s}</option>`).join('')}
                    </select>
                </div>
                <div class="field">
                    <label>Area Cost Level (in-state)</label>
                    <select class="input" name="area_level[]" required>
                        <option value="">Select Cost Level</option>
                        ${AREA_LEVELS.map(a => `<option value="${a.value}">${a.label}</option>`).join('')}
                    </select>
                </div>
                <div class="field">
                    <label>Years Living Here</label>
                    <input class="input location-years" type="number" name="location_years[]" min="1" max="100" placeholder="e.g., 5" required>
                </div>
                <div class="field">
                    <button type="button" class="btn-secondary remove-location">Remove</button>
                </div>
            </div>
        `;
        locationContainer.appendChild(row);
        updateYearValidation();
    }

    function updateYearValidation() {
        const locationYears = document.querySelectorAll('.location-years');
        let totalYears = 0;
        
        locationYears.forEach(input => {
            const years = parseInt(input.value) || 0;
            totalYears += years;
        });

        // Get current total projection years from the input field
        const currentTotalProjectionYears = parseInt(yearsCountEl.value) || 0;
        
        document.getElementById('totalYears').textContent = totalYears;
        document.getElementById('requiredYears').textContent = currentTotalProjectionYears;
        
        const validationStatus = document.getElementById('validationStatus');
        if (totalYears === currentTotalProjectionYears) {
            validationStatus.textContent = 'âœ“ Valid';
            validationStatus.className = 'validation-status valid';
            generateCostsBtn.disabled = false;
        } else if (totalYears > currentTotalProjectionYears) {
            validationStatus.textContent = 'Too many years';
            validationStatus.className = 'validation-status invalid';
            generateCostsBtn.disabled = true;
        } else {
            validationStatus.textContent = 'Incomplete';
            validationStatus.className = 'validation-status warning';
            generateCostsBtn.disabled = true;
        }
    }

    // Event listeners
    addLocationBtn.addEventListener('click', addLocationRow);
    
    // Remove location rows
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-location')) {
            e.target.closest('.location-row').remove();
            updateYearValidation();
        }
    });

    // Update validation when years change
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('location-years')) {
            updateYearValidation();
        }
        // Also update when total years changes
        if (e.target.id === 'yearsCount') {
            updateYearValidation();
        }
    });

    // Generate Results and redirect to results page
    document.getElementById('generateResults').addEventListener('click', function() {
        // Validate form
        const startYear = parseInt(startYearEl.value);
        const totalYears = parseInt(yearsCountEl.value);
        const baseIncome = parseFloat(baseIncomeEl.value);
        const growthRate = parseFloat(growthEl.value);

        if (!startYear || !totalYears || !baseIncome || isNaN(growthRate)) {
            alert('Please fill in all income fields.');
            return;
        }

        // Validate locations
        const stateSelects = document.querySelectorAll('select[name="state[]"]');
        const areaSelects = document.querySelectorAll('select[name="area_level[]"]');
        const yearInputs = document.querySelectorAll('input[name="location_years[]"]');
        let totalLocationYears = 0;
        
        for (let i = 0; i < yearInputs.length; i++) {
            const years = parseInt(yearInputs[i].value) || 0;
            totalLocationYears += years;
        }

        if (totalLocationYears !== totalYears) {
            alert(`Location years (${totalLocationYears}) must equal total projection years (${totalYears}).`);
            return;
        }

        // Save form data
        saveFormData();

        // Generate income data
        incomeData = [];
        for (let i = 0; i < totalYears; i++) {
            const year = startYear + i;
            const income = baseIncome * Math.pow(1 + (growthRate / 100), i);
            incomeData.push({
                year: year,
                income: income,
                costs: 0
            });
        }

        // Collect location data
        locationData = [];
        let currentYear = startYear;
        
        for (let i = 0; i < stateSelects.length; i++) {
            const state = stateSelects[i].value.trim();
            const areaLevel = areaSelects[i].value;
            const years = parseInt(yearInputs[i].value);
            
            if (state && years) {
                locationData.push({
                    state: state,
                    areaLevel: areaLevel,
                    startYear: currentYear,
                    endYear: currentYear + years - 1,
                    years: years
                });
                currentYear += years;
            }
        }

        // Get spending preferences
        const spendingData = {
            housing: document.getElementById('housing_spending').value,
            travel: document.getElementById('travel_spending').value,
            food: document.getElementById('food_spending').value,
            leisure: document.getElementById('leisure_spending').value
        };

        // Send data to server and redirect to results
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('generate_results', '1');
        formData.append('income_data', JSON.stringify(incomeData));
        formData.append('location_data', JSON.stringify(locationData));
        formData.append('spending_data', JSON.stringify(spendingData));

        fetch(window.location.href, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Display the editable results table
                displayResultsTable(data.entries);
                // Scroll to results table
                document.getElementById('resultsTableSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                alert('Error generating results: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error generating results. Please try again.');
        });
    });

    // Helper function to format numbers with commas
    function formatNumber(num) {
        return Number(num).toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    // Display results table with editable fields
    function displayResultsTable(entries) {
        const tbody = document.getElementById('resultsTableBody');
        const resultsSection = document.getElementById('resultsTableSection');
        
        if (!entries || entries.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6">No data available</td></tr>';
            if (resultsSection) {
                resultsSection.style.display = 'none';
            }
            return;
        }
        
        // Ensure table section is visible
        if (resultsSection) {
            resultsSection.style.display = 'block';
        }
        
        tbody.innerHTML = '';
        
        entries.forEach(entry => {
            const row = document.createElement('tr');
            const netSavings = entry.after_tax_income - entry.costs;
            
            // Extract just the state name, removing area cost level (e.g., "State (Average)" -> "State")
            let locationDisplay = entry.location || 'Unknown';
            if (locationDisplay.includes(' (')) {
                locationDisplay = locationDisplay.split(' (')[0];
            }
            
            row.innerHTML = `
                <td class="year-cell" style="font-weight: 700 !important; text-align: center !important;">${entry.year}</td>
                <td class="location-cell" style="font-weight: 700 !important; text-align: center !important;">${locationDisplay}</td>
                <td>
                    <input type="text" class="editable-income" data-year="${entry.year}" 
                           value="${formatNumber(entry.income)}" data-numeric-value="${entry.income}">
                </td>
                <td>
                    <input type="text" class="editable-costs" data-year="${entry.year}" 
                           value="${formatNumber(entry.costs)}" data-numeric-value="${entry.costs}">
                </td>
                <td class="money after-tax-income" data-year="${entry.year}">$${formatNumber(entry.after_tax_income)}</td>
                <td class="money net-savings" data-year="${entry.year}">$${formatNumber(netSavings)}</td>
            `;
            
            // Add event listeners to recalculate when income or costs change
            const incomeInput = row.querySelector('.editable-income');
            const costsInput = row.querySelector('.editable-costs');
            
            // Format input on blur and parse on focus
            function formatInput(input) {
                const numericValue = input.dataset.numericValue;
                input.value = formatNumber(numericValue || input.value.replace(/,/g, ''));
            }
            
            function parseInput(input) {
                const value = input.value.replace(/,/g, '');
                input.dataset.numericValue = value;
                input.value = value;
            }
            
            incomeInput.addEventListener('focus', () => parseInput(incomeInput));
            incomeInput.addEventListener('blur', () => formatInput(incomeInput));
            costsInput.addEventListener('focus', () => parseInput(costsInput));
            costsInput.addEventListener('blur', () => formatInput(costsInput));
            
            // Update net savings when income or costs change (taxes will be recalculated on save)
            const updateNetSavings = () => {
                // Update data attribute when input changes
                const incomeValue = incomeInput.value.replace(/,/g, '');
                const costsValue = costsInput.value.replace(/,/g, '');
                if (incomeValue) incomeInput.dataset.numericValue = incomeValue;
                if (costsValue) costsInput.dataset.numericValue = costsValue;
                
                const currentIncome = parseFloat(incomeValue) || parseFloat(incomeInput.dataset.numericValue) || 0;
                const currentCosts = parseFloat(costsValue) || parseFloat(costsInput.dataset.numericValue) || 0;
                const afterTaxIncome = entry.after_tax_income || (currentIncome * 0.75); // Temporary estimate
                const netSavings = afterTaxIncome - currentCosts;
                
                const netSavingsCell = row.querySelector('.net-savings');
                netSavingsCell.textContent = '$' + formatNumber(netSavings);
                netSavingsCell.className = 'money net-savings ' + (netSavings >= 0 ? 'positive' : 'negative');
                
                // Update after-tax income display
                const afterTaxCell = row.querySelector('.after-tax-income');
                afterTaxCell.textContent = '$' + formatNumber(afterTaxIncome);
            };
            
            incomeInput.addEventListener('input', updateNetSavings);
            costsInput.addEventListener('input', updateNetSavings);
            
            tbody.appendChild(row);
        });
    }
    
    // Save edited values
    const saveEditsBtn = document.getElementById('saveEditsBtn');
    if (saveEditsBtn) {
        saveEditsBtn.addEventListener('click', function() {
        const incomeInputs = document.querySelectorAll('.editable-income');
        const costsInputs = document.querySelectorAll('.editable-costs');
        const updates = [];
        
        incomeInputs.forEach(input => {
            const year = parseInt(input.dataset.year);
            // Remove commas before parsing
            const income = parseFloat(input.value.replace(/,/g, '')) || parseFloat(input.dataset.numericValue) || 0;
            const costsInput = document.querySelector(`.editable-costs[data-year="${year}"]`);
            const costs = parseFloat(costsInput.value.replace(/,/g, '')) || parseFloat(costsInput.dataset.numericValue) || 0;
            
            updates.push({
                year: year,
                income: income,
                costs: costs
            });
        });
        
        // Send updates to server
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('update_entries', '1');
        formData.append('updates', JSON.stringify(updates));
        
        fetch(window.location.href, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Keep table visible and update with new data
                if (data.entries && data.entries.length > 0) {
                    displayResultsTable(data.entries);
                    alert('Changes saved successfully! Taxes have been recalculated.');
                } else {
                    alert('Changes saved successfully!');
                }
            } else {
                alert('Error saving changes: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error saving changes. Please try again.');
        });
        });
    }

    // Clear form data for new users
    function clearFormData() {
        startYearEl.value = '';
        yearsCountEl.value = '';
        baseIncomeEl.value = '';
        growthEl.value = '';
        document.getElementById('housing_spending').value = 'average';
        document.getElementById('travel_spending').value = 'average';
        document.getElementById('food_spending').value = 'average';
        document.getElementById('leisure_spending').value = 'average';
        locationContainer.innerHTML = '';
        addLocationRow();
        updateYearValidation();
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        // Check if user has saved data in database
        {% if has_saved_data %}
            // Load saved data from database
            loadSavedDataFromDatabase();
            // Ensure at least one location row exists if no locations were loaded
            if (locationContainer.querySelectorAll('.location-row').length === 0) {
                addLocationRow();
            }
            updateYearValidation();
        {% else %}
            // New user - start with empty form
            clearFormData();
        {% endif %}
    });
    </script>
</body>
</html>