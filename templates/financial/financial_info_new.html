{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Information - {{ user.username }}</title>
    <link rel="stylesheet" href="{% static 'styles.css' %}?v=2.2">
    <!-- Template version: 2.1 - Percentage inputs for spending preferences -->
    <style>
        .negative {
            color: #dc2626 !important;
            font-weight: 600;
        }
        .money.negative {
            color: #dc2626 !important;
        }
    </style>
    <script>
        console.log('Template version 2.1 loaded - Using percentage inputs for spending preferences');
    </script>
</head>
<body style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 50%, #93c5fd 100%) !important; background-attachment: fixed !important;">
    <nav class="navbar" style="background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%) !important;">
        <div class="nav-container">
            <h1 class="nav-brand" style="color: #ffffff !important;">Financial Planner</h1>
            <div class="nav-links">
                <a href="{% url 'financial_dashboard' %}" class="nav-link" style="color: #e0e7ff !important;">Home</a>
                <a href="{% url 'personal_info' %}" class="nav-link" style="color: #e0e7ff !important;">Personal Info</a>
                <a href="{% url 'financial_info' %}" class="nav-link active" style="color: #ffffff !important; background-color: rgba(255, 255, 255, 0.2) !important;">Financial Info</a>
                <a href="{% url 'results' %}" class="nav-link" style="color: #e0e7ff !important;">Results</a>
                <a href="{% url 'monte_carlo_simulation' %}" class="nav-link" style="color: #e0e7ff !important;">Monte Carlo</a>
                <form method="post" action="{% url 'logout' %}" class="logout-form">
                    {% csrf_token %}
                    <button type="submit" class="logout-btn">Logout</button>
                </form>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <div style="margin-bottom: 2.5rem;">
                <h1 style="font-size: 2.5rem; font-weight: 700; color: #1e40af; margin: 0 0 0.5rem 0; letter-spacing: -0.02em;">Financial Planning</h1>
                <p style="font-size: 1.125rem; color: #475569; margin: 0;">Plan your financial future using Cost-of-Living indexes by state and your spending preferences.</p>
            </div>

            {% if messages %}
                <div class="messages">
                    {% for message in messages %}
                        <div class="message message-{{ message.tags }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}

            <div class="financial-sections">
                <!-- Combined Card with Step 1 and Step 2 -->
                <div class="card form-card step-card">
                    <!-- Step 1: Income Projection -->
                    <div class="step-section step-section-1">
                        <div class="card-header">
                            <div class="step-indicator">
                                <span class="step-number">Step 1</span>
                                <h3>Income Projection</h3>
                            </div>
                        </div>

                        <div class="card-content">
                            <form method="post" id="incomeForm" class="pretty-form">
                                {% csrf_token %}
                                <input type="hidden" name="income_mode" value="by_year">
                                
                                <div class="form-grid">
                                    <div class="field">
                                        <label for="startYear">Start Year</label>
                                        <input class="input" id="startYear" type="number" min="1900" max="2200" required>
                                    </div>
                                    <div class="field">
                                        <label for="yearsCount">Total Years to Project</label>
                                        <input class="input" id="yearsCount" type="number" min="1" max="100" required>
                                    </div>
                                </div>

                                <div class="form-grid">
                                    <div class="field">
                                        <label for="baseIncome">Starting Income ($)</label>
                                        <input class="input" id="baseIncome" type="number" step="0.01" placeholder="e.g. 100000" required>
                                    </div>
                                    <div class="field">
                                        <label for="growthPct">Annual Income Growth (%)</label>
                                        <input class="input" id="growthPct" type="number" step="0.01" min="0" placeholder="e.g. 5" required>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Step Divider -->
                    <div class="step-divider"></div>

                    <!-- Step 2: Mode Selection & Preferences -->
                    <div class="step-section step-section-2">
                        <div class="card-header">
                            <div class="step-indicator">
                                <span class="step-number">Step 2</span>
                                <h3>Spending Preferences</h3>
                            </div>
                        </div>

                        <div class="card-content">
                        <form method="post" id="locationSpendingForm" class="pretty-form">
                            {% csrf_token %}
                            
                            <!-- Mode Selection -->
                            <div class="section-header">
                                <h4>Choose Your Input Method</h4>
                                <p class="section-description">Select how you want to specify your spending preferences</p>
                            </div>
                            
                            <div class="mode-selection" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
                                <div class="mode-option" id="modeOption1" style="border: 2px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem; cursor: pointer; transition: all 0.3s; user-select: none;" role="button" tabindex="0" onclick="selectMode(1)" onkeydown="if(event.key==='Enter'||event.key===' '){selectMode(1);event.preventDefault();}">
                                    <input type="radio" name="spending_mode" id="mode1" value="location_based" style="display: none;">
                                    <div style="pointer-events: none;">
                                        <h4 style="margin: 0 0 0.5rem 0; color: #1f2937;">Option 1: Location-Based</h4>
                                        <p style="margin: 0; color: #6b7280; font-size: 0.9rem;">Use location-specific cost of living adjustments with average spending preferences</p>
                                        <ul style="margin: 0.75rem 0 0 0; padding-left: 1.25rem; color: #4b5563; font-size: 0.85rem;">
                                            <li>Select locations where you'll live</li>
                                            <li>Choose spending level (Very Little to Very High)</li>
                                            <li>Costs adjusted by location's cost of living</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="mode-option" id="modeOption2" style="border: 2px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem; cursor: pointer; transition: all 0.3s; user-select: none;" role="button" tabindex="0" onclick="selectMode(2)" onkeydown="if(event.key==='Enter'||event.key===' '){selectMode(2);event.preventDefault();}">
                                    <input type="radio" name="spending_mode" id="mode2" value="percentage_based" style="display: none;">
                                    <div style="pointer-events: none;">
                                        <h4 style="margin: 0 0 0.5rem 0; color: #1f2937;">Option 2: Percentage-Based</h4>
                                        <p style="margin: 0; color: #6b7280; font-size: 0.9rem;">Specify exact percentages of your after-tax income for each category</p>
                                        <ul style="margin: 0.75rem 0 0 0; padding-left: 1.25rem; color: #4b5563; font-size: 0.85rem;">
                                            <li>Enter percentage of income for each category</li>
                                            <li>No location selection needed</li>
                                            <li>More precise control over spending</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Option 1: Location-Based Section -->
                            <div id="option1Section" style="display: none;">
                                <!-- Location Section -->
                                <div class="section-header">
                                    <h4>Where Will You Live?</h4>
                                    <p class="section-description">Add locations and specify how many years you'll live in each place</p>
                                </div>

                                <div id="locationContainer"></div>
                                
                                <div class="location-controls">
                                    <button type="button" id="addLocation" class="btn-secondary">
                                        <i class="fas fa-plus"></i> Add Another Location
                                    </button>
                                    <div class="year-validation" id="yearValidation">
                                        <span class="validation-text">Total years: <span id="totalYears">0</span> / <span id="requiredYears">0</span></span>
                                        <span class="validation-status" id="validationStatus"></span>
                                    </div>
                                </div>

                                <!-- Option 1: Old Spending Preferences (Dropdowns) -->
                                <div class="section-header" style="margin-top: 2rem;">
                                    <h4>Spending Preferences</h4>
                                    <p class="section-description">Rate your spending habits for each category</p>
                                </div>

                                <div class="form-grid">
                                    <div class="field">
                                        <label for="housing_spending_dropdown">Housing Spending</label>
                                        <select class="input" id="housing_spending_dropdown" name="housing_spending_dropdown">
                                            <option value="very_little">Very Little</option>
                                            <option value="less_than_average">Less Than Average</option>
                                            <option value="average" selected>Average</option>
                                            <option value="above_average">Above Average</option>
                                            <option value="very_high">Very High</option>
                                        </select>
                                    </div>
                                    <div class="field">
                                        <label for="travel_spending_dropdown">Travel Spending</label>
                                        <select class="input" id="travel_spending_dropdown" name="travel_spending_dropdown">
                                            <option value="very_little">Very Little</option>
                                            <option value="less_than_average">Less Than Average</option>
                                            <option value="average" selected>Average</option>
                                            <option value="above_average">Above Average</option>
                                            <option value="very_high">Very High</option>
                                        </select>
                                    </div>
                                    <div class="field">
                                        <label for="food_spending_dropdown">Food & Groceries</label>
                                        <select class="input" id="food_spending_dropdown" name="food_spending_dropdown">
                                            <option value="very_little">Very Little</option>
                                            <option value="less_than_average">Less Than Average</option>
                                            <option value="average" selected>Average</option>
                                            <option value="above_average">Above Average</option>
                                            <option value="very_high">Very High</option>
                                        </select>
                                    </div>
                                    <div class="field">
                                        <label for="leisure_spending_dropdown">Leisure Spending</label>
                                        <select class="input" id="leisure_spending_dropdown" name="leisure_spending_dropdown">
                                            <option value="very_little">Very Little</option>
                                            <option value="less_than_average">Less Than Average</option>
                                            <option value="average" selected>Average</option>
                                            <option value="above_average">Above Average</option>
                                            <option value="very_high">Very High</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Option 2: Percentage-Based Section -->
                            <div id="option2Section" style="display: none;">
                                <!-- Spending Preferences Section -->
                                <div class="section-header">
                                    <h4>Spending Preferences</h4>
                                    <p class="section-description">Enter the percentage of your after-tax income you plan to spend in each category</p>
                                </div>

                                <div class="form-grid">
                                    <div class="field">
                                        <label for="housing_spending">Housing Spending (%)</label>
                                        <input class="input" id="housing_spending" name="housing_spending" type="number" step="0.01" min="0" max="100" placeholder="e.g. 30" value="30">
                                        <small class="field-help">Percentage of after-tax income for housing</small>
                                    </div>
                                    <div class="field">
                                        <label for="travel_spending">Travel Spending (%)</label>
                                        <input class="input" id="travel_spending" name="travel_spending" type="number" step="0.01" min="0" max="100" placeholder="e.g. 10" value="10">
                                        <small class="field-help">Percentage of after-tax income for travel</small>
                                    </div>
                                    <div class="field">
                                        <label for="food_spending">Food & Groceries (%)</label>
                                        <input class="input" id="food_spending" name="food_spending" type="number" step="0.01" min="0" max="100" placeholder="e.g. 15" value="15">
                                        <small class="field-help">Percentage of after-tax income for food</small>
                                    </div>
                                    <div class="field">
                                        <label for="leisure_spending">Leisure Spending (%)</label>
                                        <input class="input" id="leisure_spending" name="leisure_spending" type="number" step="0.01" min="0" max="100" placeholder="e.g. 10" value="10">
                                        <small class="field-help">Percentage of after-tax income for leisure</small>
                                    </div>
                                </div>
                                <div class="spending-total" id="spendingTotal" style="margin-top: 1rem; padding: 0.75rem; background: #f3f4f6; border-radius: 0.5rem;">
                                    <strong>Total Spending: <span id="totalSpendingPercent">65.00</span>%</strong>
                                    <small style="display: block; color: #6b7280; margin-top: 0.25rem;">Remaining: <span id="remainingPercent">35.00</span>% (for savings and other expenses)</small>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="button" id="generateResults" class="btn-primary">
                                    Generate Results
                                </button>
                                <span id="viewResultsBtn" class="view-results-disabled" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; background: #9ca3af; color: white; border-radius: 0.5rem; font-weight: 600; opacity: 0.6; cursor: not-allowed; user-select: none;">
                                    View Results
                                </span>
                                <a href="{% url 'results' %}" id="viewResultsBtnActive" class="btn-secondary" style="text-decoration: none; display: none;">
                                    View Results
                                </a>
                            </div>
                        </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Table Section - Below Step 1 and Step 2 -->
            <div class="financial-sections" style="margin-top: 2rem;">
                <div class="card form-card" id="resultsTableSection" style="display: none;">
                <div class="card-header">
                    <h3>Annual Income & Costs</h3>
                    <div class="form-toolbar">
                        <button type="button" id="saveEditsBtn" class="btn-primary">Save Changes</button>
                    </div>
                </div>
                <div class="card-content">
                    <p class="section-description">Review and edit your annual income and costs. Values are auto-populated from Step 1 and Step 2.</p>
                    
                    <!-- Option 1 Table: Location-Based (with Location column) -->
                    <div class="table-container" id="tableOption1" style="display: none;">
                        <table class="table" id="resultsTableOption1">
                            <colgroup>
                                <col style="width: 16.6667%;">
                                <col style="width: 16.6667%;">
                                <col style="width: 16.6667%;">
                                <col style="width: 16.6667%;">
                                <col style="width: 16.6667%;">
                                <col style="width: 16.6667%;">
                            </colgroup>
                            <thead>
                                <tr>
                                    <th>Year</th>
                                    <th>Location</th>
                                    <th>Income ($)</th>
                                    <th>Costs ($)</th>
                                    <th>After-Tax Income ($)</th>
                                    <th>Annual Savings ($)</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBodyOption1">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Option 2 Table: Percentage-Based (without Location column) -->
                    <div class="table-container" id="tableOption2" style="display: none;">
                        <table class="table" id="resultsTableOption2">
                            <colgroup>
                                <col style="width: 20%;">
                                <col style="width: 20%;">
                                <col style="width: 20%;">
                                <col style="width: 20%;">
                                <col style="width: 20%;">
                            </colgroup>
                            <thead>
                                <tr>
                                    <th>Year</th>
                                    <th>Income ($)</th>
                                    <th>Costs ($)</th>
                                    <th>After-Tax Income ($)</th>
                                    <th>Annual Savings ($)</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBodyOption2">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </main>

    {% if location_preferences %}
        {{ location_preferences|json_script:"saved-locations" }}
    {% endif %}

    <script>
    // Global variables
    let incomeData = [];
    let locationData = [];
    let totalProjectionYears = 0;
    let startYear = 2025;
    let selectedMode = null; // 1 = location-based, 2 = percentage-based

    // DOM elements
    const startYearEl = document.getElementById('startYear');
    const yearsCountEl = document.getElementById('yearsCount');
    const baseIncomeEl = document.getElementById('baseIncome');
    const growthEl = document.getElementById('growthPct');
    
    // Prevent negative values in growth field
    if (growthEl) {
        growthEl.addEventListener('input', function() {
            if (this.value < 0) {
                this.value = 0;
            }
        });
        growthEl.addEventListener('change', function() {
            if (this.value < 0) {
                this.value = 0;
            }
        });
    }
    const locationContainer = document.getElementById('locationContainer');
    const addLocationBtn = document.getElementById('addLocation');
    const generateCostsBtn = document.getElementById('generateResults');
    const resultsSection = document.getElementById('resultsSection');
    const resultsTableBody = document.getElementById('resultsTableBody');

    // State options for dropdown
    const STATES = [
        "West Virginia","Oklahoma","Kansas","Mississippi","Alabama","Arkansas","Missouri","Iowa","Michigan","Indiana","Tennessee","Georgia","North Dakota","Louisiana","South Dakota","Texas","Kentucky","Nebraska","New Mexico","Ohio","Illinois","Montana","Minnesota","Pennsylvania","Wyoming","South Carolina","Wisconsin","North Carolina","Virginia","Delaware","Nevada","Colorado","Idaho","Florida","Utah","Arizona","Oregon","Maine","Rhode Island","Connecticut","New Hampshire","Washington","Vermont","New Jersey","Maryland","New York","Alaska","District of Columbia","California","Massachusetts","Hawaii"
    ];

    const AREA_LEVELS = [
        { value: 'very_low', label: 'Very Low' },
        { value: 'less_than_average', label: 'Less Than Average' },
        { value: 'average', label: 'Average' },
        { value: 'above_average', label: 'Above Average' },
        { value: 'very_high', label: 'Very High' }
    ];

    // Calculate and update total spending percentage
    function updateSpendingTotal() {
        const housing = parseFloat(document.getElementById('housing_spending').value) || 0;
        const travel = parseFloat(document.getElementById('travel_spending').value) || 0;
        const food = parseFloat(document.getElementById('food_spending').value) || 0;
        const leisure = parseFloat(document.getElementById('leisure_spending').value) || 0;
        
        const total = housing + travel + food + leisure;
        const remaining = 100 - total;
        
        document.getElementById('totalSpendingPercent').textContent = total.toFixed(2);
        document.getElementById('remainingPercent').textContent = remaining.toFixed(2);
        
        // Change color if total exceeds 100%
        const totalElement = document.getElementById('spendingTotal');
        if (total > 100) {
            totalElement.style.background = '#fee2e2';
            totalElement.style.color = '#991b1b';
        } else if (total > 90) {
            totalElement.style.background = '#fef3c7';
            totalElement.style.color = '#92400e';
        } else {
            totalElement.style.background = '#f3f4f6';
            totalElement.style.color = '#1f2937';
        }
    }

    // Mode selection function
    function selectMode(mode) {
        selectedMode = mode;
        
        // Update radio button
        const radio = document.getElementById('mode' + mode);
        if (radio) radio.checked = true;
        
        // Update visual selection
        document.querySelectorAll('.mode-option').forEach(opt => {
            opt.style.borderColor = '#e5e7eb';
            opt.style.backgroundColor = '';
        });
        const selectedOption = document.getElementById('modeOption' + mode);
        if (selectedOption) {
            selectedOption.style.borderColor = '#3b82f6';
            selectedOption.style.backgroundColor = '#eff6ff';
        }
        
        // Show/hide sections
        if (mode === 1) {
            document.getElementById('option1Section').style.display = 'block';
            document.getElementById('option2Section').style.display = 'none';
            
            // Ensure at least one location row exists
            const locationContainer = document.getElementById('locationContainer');
            if (locationContainer && locationContainer.querySelectorAll('.location-row').length === 0) {
                addLocationRow();
            }
            
            // Make location fields required
            document.querySelectorAll('#option1Section select[name="state[]"], #option1Section select[name="area_level[]"], #option1Section input[name="location_years[]"]').forEach(el => {
                el.required = true;
            });
            // Make dropdown spending fields required
            ['housing_spending_dropdown', 'travel_spending_dropdown', 'food_spending_dropdown', 'leisure_spending_dropdown'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.required = true;
            });
            // Make percentage fields not required
            ['housing_spending', 'travel_spending', 'food_spending', 'leisure_spending'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.required = false;
            });
        } else {
            document.getElementById('option1Section').style.display = 'none';
            document.getElementById('option2Section').style.display = 'block';
            // Make location fields not required
            document.querySelectorAll('#option1Section select[name="state[]"], #option1Section select[name="area_level[]"], #option1Section input[name="location_years[]"]').forEach(el => {
                el.required = false;
            });
            // Make dropdown spending fields not required
            ['housing_spending_dropdown', 'travel_spending_dropdown', 'food_spending_dropdown', 'leisure_spending_dropdown'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.required = false;
            });
            // Make percentage fields required
            ['housing_spending', 'travel_spending', 'food_spending', 'leisure_spending'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.required = true;
            });
        }
        
        // Save mode selection to localStorage
        localStorage.setItem('selectedSpendingMode', mode.toString());
        
        // Update button state after mode selection
        updateYearValidation();
    }

    // Function to setup spending total calculation
    function setupSpendingTotalCalculation() {
        const spendingInputs = ['housing_spending', 'travel_spending', 'food_spending', 'leisure_spending'];
        spendingInputs.forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.addEventListener('input', updateSpendingTotal);
                input.addEventListener('change', updateSpendingTotal);
            }
        });
        // Initial calculation
        updateSpendingTotal();
    }

    // Load saved form data from database (passed from server)
    function loadSavedDataFromDatabase() {
        const savedData = localStorage.getItem('financialFormData');
        let formData = null;
        if (savedData) {
            try {
                formData = JSON.parse(savedData);
                // Load all form fields from localStorage
                if (formData.startYear) startYearEl.value = formData.startYear;
                if (formData.yearsCount) yearsCountEl.value = formData.yearsCount;
                if (formData.baseIncome) baseIncomeEl.value = formData.baseIncome;
                if (formData.growthPct) growthEl.value = formData.growthPct; // Preserve user's growth rate
                if (formData.housingSpending) document.getElementById('housing_spending').value = formData.housingSpending;
                if (formData.travelSpending) document.getElementById('travel_spending').value = formData.travelSpending;
                if (formData.foodSpending) document.getElementById('food_spending').value = formData.foodSpending;
                if (formData.leisureSpending) document.getElementById('leisure_spending').value = formData.leisureSpending;
                
                // Load locations from localStorage
                if (formData.locations && formData.locations.length > 0) {
                    locationContainer.innerHTML = '';
                    formData.locations.forEach((loc) => {
                        addLocationRow();
                        const stateSelects = document.querySelectorAll('select[name="state[]"]');
                        const areaSelects = document.querySelectorAll('select[name="area_level[]"]');
                        const yearInputs = document.querySelectorAll('input[name="location_years[]"]');
                        const lastIndex = stateSelects.length - 1;
                        if (stateSelects[lastIndex]) {
                            stateSelects[lastIndex].value = loc.state;
                            areaSelects[lastIndex].value = loc.areaLevel;
                            yearInputs[lastIndex].value = loc.years;
                        }
                    });
                }
            } catch (e) {
                console.error('Error loading from localStorage:', e);
            }
        }
        
        // Check if has_saved_data flag is set to true
        {% if has_saved_data %}
            {% if income_data %}
                if (!startYearEl.value) startYearEl.value = {{ income_data.startYear }};
                if (!yearsCountEl.value) yearsCountEl.value = {{ income_data.totalYears }};
                if (!baseIncomeEl.value) baseIncomeEl.value = {{ income_data.startingIncome }};
                if (!growthEl.value) growthEl.value = {{ income_data.growthRate|floatformat:2 }};
            {% endif %}
            
            // Load spending preferences from database if not in localStorage
            {% if spending_preference %}
                if (!document.getElementById('housing_spending').value) {
                    document.getElementById('housing_spending').value = '{{ spending_preference.housing_spending }}';
                }
                if (!document.getElementById('travel_spending').value) {
                    document.getElementById('travel_spending').value = '{{ spending_preference.travel_spending }}';
                }
                if (!document.getElementById('food_spending').value) {
                    document.getElementById('food_spending').value = '{{ spending_preference.food_spending }}';
                }
                if (!document.getElementById('leisure_spending').value) {
                    document.getElementById('leisure_spending').value = '{{ spending_preference.leisure_spending }}';
                }
                // Update total after loading values
                updateSpendingTotal();
            {% endif %}
            
            // Load locations from database if not in localStorage
            const savedLocationsEl = document.getElementById('saved-locations');
            if (savedLocationsEl && locationContainer.querySelectorAll('.location-row').length === 0) {
                locationContainer.innerHTML = '';
                const savedLocations = JSON.parse(savedLocationsEl.textContent);
                savedLocations.forEach((loc) => {
                    addLocationRow();
                    const stateSelects = document.querySelectorAll('select[name="state[]"]');
                    const areaSelects = document.querySelectorAll('select[name="area_level[]"]');
                    const yearInputs = document.querySelectorAll('input[name="location_years[]"]');
                    const lastIndex = stateSelects.length - 1;
                    if (stateSelects[lastIndex]) {
                        stateSelects[lastIndex].value = loc.state;
                        areaSelects[lastIndex].value = loc.areaLevel;
                        const years = loc.endYear - loc.startYear + 1;
                        yearInputs[lastIndex].value = years;
                    }
                });
            }
            
            updateYearValidation();
        {% endif %}
    }

    // Save form data
    function saveFormData() {
        const stateSelects = document.querySelectorAll('select[name="state[]"]');
        const areaSelects = document.querySelectorAll('select[name="area_level[]"]');
        const yearInputs = document.querySelectorAll('input[name="location_years[]"]');
        const locations = [];
        
        for (let i = 0; i < stateSelects.length; i++) {
            if (stateSelects[i].value.trim()) {
                locations.push({
                    state: stateSelects[i].value.trim(),
                    areaLevel: areaSelects[i].value,
                    years: parseInt(yearInputs[i].value) || 0
                });
            }
        }
        
        const formData = {
            startYear: startYearEl.value,
            yearsCount: yearsCountEl.value,
            baseIncome: baseIncomeEl.value,
            growthPct: growthEl.value,
            housingSpending: document.getElementById('housing_spending').value,
            travelSpending: document.getElementById('travel_spending').value,
            foodSpending: document.getElementById('food_spending').value,
            leisureSpending: document.getElementById('leisure_spending').value,
            locations: locations
        };
        
        localStorage.setItem('financialFormData', JSON.stringify(formData));
    }

    // Step 2: Location Management
    function addLocationRow() {
        const row = document.createElement('div');
        row.className = 'location-row';
        row.innerHTML = `
            <div class="form-grid">
                <div class="field">
                    <label>State</label>
                    <select class="input" name="state[]" required>
                        <option value="">Select State</option>
                        ${STATES.map(s => `<option value="${s}">${s}</option>`).join('')}
                    </select>
                </div>
                <div class="field">
                    <label>Area Cost Level (in-state)</label>
                    <select class="input" name="area_level[]" required>
                        <option value="">Select Cost Level</option>
                        ${AREA_LEVELS.map(a => `<option value="${a.value}">${a.label}</option>`).join('')}
                    </select>
                </div>
                <div class="field">
                    <label>Years Living Here</label>
                    <input class="input location-years" type="number" name="location_years[]" min="1" max="100" placeholder="e.g., 5" required>
                </div>
                <div class="field">
                    <button type="button" class="btn-secondary remove-location">Remove</button>
                </div>
            </div>
        `;
        locationContainer.appendChild(row);
        updateYearValidation();
    }

    function updateYearValidation() {
        // Only validate location years for Option 1 (location-based mode)
        if (selectedMode !== 1) {
            // For Option 2, enable button if mode is selected and basic fields are filled
            if (selectedMode === 2) {
                const hasIncomeData = startYearEl.value && yearsCountEl.value && baseIncomeEl.value && growthEl.value;
                const hasSpendingData = document.getElementById('housing_spending')?.value && 
                                       document.getElementById('travel_spending')?.value &&
                                       document.getElementById('food_spending')?.value &&
                                       document.getElementById('leisure_spending')?.value;
                generateCostsBtn.disabled = !(hasIncomeData && hasSpendingData);
            } else {
                // No mode selected yet
                generateCostsBtn.disabled = true;
            }
            return;
        }
        
        // Option 1 validation: check location years
        const locationYears = document.querySelectorAll('.location-years');
        let totalYears = 0;
        
        locationYears.forEach(input => {
            const years = parseInt(input.value) || 0;
            totalYears += years;
        });

        // Get current total projection years from the input field
        const currentTotalProjectionYears = parseInt(yearsCountEl.value) || 0;
        
        if (document.getElementById('totalYears')) {
            document.getElementById('totalYears').textContent = totalYears;
        }
        if (document.getElementById('requiredYears')) {
            document.getElementById('requiredYears').textContent = currentTotalProjectionYears;
        }
        
        const validationStatus = document.getElementById('validationStatus');
        if (validationStatus) {
            if (totalYears === currentTotalProjectionYears && currentTotalProjectionYears > 0) {
                validationStatus.textContent = 'âœ“ Valid';
                validationStatus.className = 'validation-status valid';
                generateCostsBtn.disabled = false;
            } else if (totalYears > currentTotalProjectionYears) {
                validationStatus.textContent = 'Too many years';
                validationStatus.className = 'validation-status invalid';
                generateCostsBtn.disabled = true;
            } else {
                validationStatus.textContent = 'Incomplete';
                validationStatus.className = 'validation-status warning';
                generateCostsBtn.disabled = true;
            }
        }
    }

    // Event listeners
    addLocationBtn.addEventListener('click', addLocationRow);
    
    // Remove location rows
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-location')) {
            e.target.closest('.location-row').remove();
            updateYearValidation();
        }
    });

    // Update validation when years change
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('location-years')) {
            updateYearValidation();
        }
        // Also update when total years changes
        if (e.target.id === 'yearsCount') {
            updateYearValidation();
        }
        // Update when income fields change (for Option 2)
        if (['startYear', 'yearsCount', 'baseIncome', 'growthPct'].includes(e.target.id)) {
            updateYearValidation();
        }
        // Update when spending percentage fields change (for Option 2)
        if (['housing_spending', 'travel_spending', 'food_spending', 'leisure_spending'].includes(e.target.id)) {
            updateYearValidation();
        }
    });

    // Save form data to localStorage whenever Step 1 fields change
    function setupFormAutoSave() {
        [startYearEl, yearsCountEl, baseIncomeEl, growthEl].forEach(input => {
            if (input) {
                input.addEventListener('input', saveFormData);
                input.addEventListener('change', saveFormData);
            }
        });
        
        // Save when spending preferences change
        ['housing_spending', 'travel_spending', 'food_spending', 'leisure_spending'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', saveFormData);
            }
        });
    }

    // Generate Results and redirect to results page
    document.getElementById('generateResults').addEventListener('click', function() {
        // Validate form
        const startYear = parseInt(startYearEl.value);
        const totalYears = parseInt(yearsCountEl.value);
        const baseIncome = parseFloat(baseIncomeEl.value);
        const growthRate = parseFloat(growthEl.value);

        if (!startYear || !totalYears || !baseIncome || isNaN(growthRate)) {
            alert('Please fill in all income fields.');
            return;
        }

        // Get location form elements (needed for both validation and data collection)
        const stateSelects = document.querySelectorAll('select[name="state[]"]');
        const areaSelects = document.querySelectorAll('select[name="area_level[]"]');
        const yearInputs = document.querySelectorAll('input[name="location_years[]"]');
        
        // Validate locations (only for Option 1)
        if (selectedMode === 1) {
            let totalLocationYears = 0;
            
            for (let i = 0; i < yearInputs.length; i++) {
                const years = parseInt(yearInputs[i].value) || 0;
                totalLocationYears += years;
            }

            if (totalLocationYears !== totalYears) {
                alert(`Location years (${totalLocationYears}) must equal total projection years (${totalYears}).`);
                return;
            }
        }

        // Save form data
        saveFormData();

        // Generate income data
        incomeData = [];
        for (let i = 0; i < totalYears; i++) {
            const year = startYear + i;
            const income = baseIncome * Math.pow(1 + (growthRate / 100), i);
            incomeData.push({
                year: year,
                income: income,
                costs: 0
            });
        }

        // Collect location data (only for Option 1)
        locationData = [];
        if (selectedMode === 1) {
            let currentYear = startYear;
            
            for (let i = 0; i < stateSelects.length; i++) {
                const state = stateSelects[i].value.trim();
                const areaLevel = areaSelects[i].value;
                const years = parseInt(yearInputs[i].value);
                
                if (state && years) {
                    locationData.push({
                        state: state,
                        areaLevel: areaLevel,
                        startYear: currentYear,
                        endYear: currentYear + years - 1,
                        years: years
                    });
                    currentYear += years;
                }
            }
        }

        // Validate mode is selected
        if (!selectedMode) {
            alert('Please select an option (Location-Based or Percentage-Based) before generating results.');
            return;
        }
        
        // Get spending preferences based on selected mode
        let spendingData = {};
        if (selectedMode === 1) {
            // Option 1: Location-based with dropdowns
            // Validate that location data exists
            if (locationData.length === 0) {
                alert('Please add at least one location for Option 1 (Location-Based mode).');
                return;
            }
            
            spendingData = {
                mode: 'location_based',
                housing: document.getElementById('housing_spending_dropdown').value,
                travel: document.getElementById('travel_spending_dropdown').value,
                food: document.getElementById('food_spending_dropdown').value,
                leisure: document.getElementById('leisure_spending_dropdown').value
            };
        } else {
            // Option 2: Percentage-based
            spendingData = {
                mode: 'percentage_based',
                housing: parseFloat(document.getElementById('housing_spending').value) || 0,
                travel: parseFloat(document.getElementById('travel_spending').value) || 0,
                food: parseFloat(document.getElementById('food_spending').value) || 0,
                leisure: parseFloat(document.getElementById('leisure_spending').value) || 0
            };
            
            // Validate total doesn't exceed 100%
            const totalSpending = spendingData.housing + spendingData.travel + spendingData.food + spendingData.leisure;
            if (totalSpending > 100) {
                alert('Total spending cannot exceed 100% of income. Please adjust your spending preferences.');
                return;
            }
        }

        // Send data to server and redirect to results
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('generate_results', '1');
        formData.append('income_data', JSON.stringify(incomeData));
        formData.append('location_data', JSON.stringify(locationData));
        formData.append('spending_data', JSON.stringify(spendingData));
        
        // Debug logging
        console.log('Sending data to server:');
        console.log('Mode:', selectedMode, 'Spending mode:', spendingData.mode);
        console.log('Location data:', locationData);
        console.log('Spending data:', spendingData);

        fetch(window.location.href, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Display the editable results table with the appropriate mode
                const mode = data.spending_mode || spendingData.mode || 'percentage_based';
                displayResultsTable(data.entries, mode);
                document.getElementById('resultsTableSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
                const viewResultsBtn = document.getElementById('viewResultsBtn');
                const viewResultsBtnActive = document.getElementById('viewResultsBtnActive');
                if (viewResultsBtn) {
                    viewResultsBtn.style.display = 'none';
                }
                if (viewResultsBtnActive) {
                    viewResultsBtnActive.style.display = 'inline-block';
                }
            } else {
                alert('Error generating results: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error generating results. Please try again.');
        });
    });

    // Helper function to format numbers with commas
    function formatNumber(num) {
        return Number(num).toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    // Display results table with editable fields
    function displayResultsTable(entries, mode) {
        const resultsSection = document.getElementById('resultsTableSection');
        const tableOption1 = document.getElementById('tableOption1');
        const tableOption2 = document.getElementById('tableOption2');
        const tbodyOption1 = document.getElementById('resultsTableBodyOption1');
        const tbodyOption2 = document.getElementById('resultsTableBodyOption2');
        
        if (!entries || entries.length === 0) {
            if (resultsSection) {
                resultsSection.style.display = 'none';
            }
            return;
        }
        
        // Determine which mode to use
        const isLocationBased = mode === 'location_based' || mode === 1;
        
        // Show/hide appropriate table
        if (isLocationBased) {
            if (tableOption1) tableOption1.style.display = 'block';
            if (tableOption2) tableOption2.style.display = 'none';
        } else {
            if (tableOption1) tableOption1.style.display = 'none';
            if (tableOption2) tableOption2.style.display = 'block';
        }
        
        // Ensure table section is visible
        if (resultsSection) {
            resultsSection.style.display = 'block';
        }
        
        // Clear both table bodies
        if (tbodyOption1) tbodyOption1.innerHTML = '';
        if (tbodyOption2) tbodyOption2.innerHTML = '';
        
        // Determine which tbody to use
        const tbody = isLocationBased ? tbodyOption1 : tbodyOption2;
        
        entries.forEach(entry => {
            const row = document.createElement('tr');
            const netSavings = entry.after_tax_income - entry.costs;
            
            if (isLocationBased) {
                // Option 1: Location-based table (with Location column)
                let locationDisplay = entry.location || 'Unknown';
                if (locationDisplay.includes(' (')) {
                    // Show just the state name (remove area level in parentheses)
                    locationDisplay = locationDisplay.split(' (')[0];
                }
                
                row.innerHTML = `
                    <td class="year-cell" style="font-weight: 700 !important; text-align: center !important;">${entry.year}</td>
                    <td class="location-cell" style="font-weight: 700 !important; text-align: center !important;">${locationDisplay}</td>
                    <td>
                        <input type="text" class="editable-income" data-year="${entry.year}" 
                               value="${formatNumber(entry.income)}" data-numeric-value="${entry.income}">
                    </td>
                    <td>
                        <input type="text" class="editable-costs" data-year="${entry.year}" 
                               value="${formatNumber(entry.costs)}" data-numeric-value="${entry.costs}">
                    </td>
                    <td class="money after-tax-income" data-year="${entry.year}">$${formatNumber(entry.after_tax_income)}</td>
                    <td class="money net-savings ${netSavings < 0 ? 'negative' : ''}" data-year="${entry.year}">$${formatNumber(Math.abs(netSavings))}</td>
                `;
            } else {
                // Option 2: Percentage-based table (without Location column)
                row.innerHTML = `
                    <td class="year-cell" style="font-weight: 700 !important; text-align: center !important;">${entry.year}</td>
                    <td>
                        <input type="text" class="editable-income" data-year="${entry.year}" 
                               value="${formatNumber(entry.income)}" data-numeric-value="${entry.income}">
                    </td>
                    <td>
                        <input type="text" class="editable-costs" data-year="${entry.year}" 
                               value="${formatNumber(entry.costs)}" data-numeric-value="${entry.costs}">
                    </td>
                    <td class="money after-tax-income" data-year="${entry.year}">$${formatNumber(entry.after_tax_income)}</td>
                    <td class="money net-savings ${netSavings < 0 ? 'negative' : ''}" data-year="${entry.year}">$${formatNumber(Math.abs(netSavings))}</td>
                `;
            }
            
            // Add event listeners to recalculate when income or costs change
            const incomeInput = row.querySelector('.editable-income');
            const costsInput = row.querySelector('.editable-costs');
            
            // Format input on blur and parse on focus
            function formatInput(input) {
                const numericValue = input.dataset.numericValue;
                input.value = formatNumber(numericValue || input.value.replace(/,/g, ''));
            }
            
            function parseInput(input) {
                const value = input.value.replace(/,/g, '');
                input.dataset.numericValue = value;
                input.value = value;
            }
            
            incomeInput.addEventListener('focus', () => parseInput(incomeInput));
            incomeInput.addEventListener('blur', () => formatInput(incomeInput));
            costsInput.addEventListener('focus', () => parseInput(costsInput));
            costsInput.addEventListener('blur', () => formatInput(costsInput));
            
     
            if (entry.income && entry.income > 0 && entry.after_tax_income !== undefined && entry.after_tax_income !== null) {
                const calculatedRate = (entry.income - entry.after_tax_income) / entry.income;
                // Validate tax rate is reasonable (0% to 50%)
                if (!isNaN(calculatedRate) && calculatedRate >= 0 && calculatedRate <= 0.5) {
                    initialTaxRate = calculatedRate;
                }
            }
            
            // Update net savings when income or costs change (taxes will be recalculated on save)
            const updateNetSavings = () => {
                const incomeValue = incomeInput.value.replace(/,/g, '');
                const costsValue = costsInput.value.replace(/,/g, '');
                if (incomeValue) incomeInput.dataset.numericValue = incomeValue;
                if (costsValue) costsInput.dataset.numericValue = costsValue;
                
                const currentIncome = parseFloat(incomeValue) || parseFloat(incomeInput.dataset.numericValue) || 0;
                const currentCosts = parseFloat(costsValue) || parseFloat(costsInput.dataset.numericValue) || 0;
                
              
                const estimatedTaxRate = Math.max(0, Math.min(0.5, initialTaxRate));
                let afterTaxIncome;
                if (currentIncome > 0) {
                    afterTaxIncome = currentIncome * (1 - estimatedTaxRate);
                } else {
                    afterTaxIncome = 0;
                }
                
                const netSavings = afterTaxIncome - currentCosts;
                
                const netSavingsCell = row.querySelector('.net-savings');
                netSavingsCell.textContent = '$' + formatNumber(Math.abs(netSavings));
                netSavingsCell.className = 'money net-savings ' + (netSavings >= 0 ? 'positive' : 'negative');
                
                // Update after-tax income display (always black, no negative styling)
                const afterTaxCell = row.querySelector('.after-tax-income');
                afterTaxCell.textContent = '$' + formatNumber(afterTaxIncome);
                afterTaxCell.className = 'money after-tax-income';
            };
            
            incomeInput.addEventListener('input', updateNetSavings);
            costsInput.addEventListener('input', updateNetSavings);
            
            // Auto-save on blur (when user leaves the field)
            let saveTimeout;
            function autoSave() {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    // Trigger save without showing alert
                    const incomeInputs = document.querySelectorAll('.editable-income');
                    const costsInputs = document.querySelectorAll('.editable-costs');
                    const updates = [];
                    
                    incomeInputs.forEach(input => {
                        const year = parseInt(input.dataset.year);
                        const income = parseFloat(input.value.replace(/,/g, '')) || parseFloat(input.dataset.numericValue) || 0;
                        const costsInput = document.querySelector(`.editable-costs[data-year="${year}"]`);
                        const costs = parseFloat(costsInput.value.replace(/,/g, '')) || parseFloat(costsInput.dataset.numericValue) || 0;
                        
                        updates.push({
                            year: year,
                            income: income,
                            costs: costs
                        });
                    });
                    
                    if (updates.length > 0) {
                        const formData = new FormData();
                        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                        formData.append('update_entries', '1');
                        formData.append('updates', JSON.stringify(updates));
                        
                        fetch(window.location.href, {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.entries && data.entries.length > 0) {
                                // Update the table with saved data
                                const firstEntry = data.entries[0];
                                const detectedMode = (firstEntry.location === "N/A" || !firstEntry.location || firstEntry.location === "Unknown") 
                                    ? 'percentage_based' 
                                    : 'location_based';
                                displayResultsTable(data.entries, detectedMode);
                            }
                        })
                        .catch(error => {
                            console.error('Auto-save error:', error);
                        });
                    }
                }, 1000); // Save 1 second after user stops typing
            }
            
            incomeInput.addEventListener('blur', autoSave);
            costsInput.addEventListener('blur', autoSave);
            
            tbody.appendChild(row);
        });
    }
    
    // Save edited values (manual save button)
    const saveEditsBtn = document.getElementById('saveEditsBtn');
    if (saveEditsBtn) {
        saveEditsBtn.addEventListener('click', function() {
        const incomeInputs = document.querySelectorAll('.editable-income');
        const costsInputs = document.querySelectorAll('.editable-costs');
        const updates = [];
        
        incomeInputs.forEach(input => {
            const year = parseInt(input.dataset.year);
            // Remove commas before parsing
            const income = parseFloat(input.value.replace(/,/g, '')) || parseFloat(input.dataset.numericValue) || 0;
            const costsInput = document.querySelector(`.editable-costs[data-year="${year}"]`);
            const costs = parseFloat(costsInput.value.replace(/,/g, '')) || parseFloat(costsInput.dataset.numericValue) || 0;
            
            updates.push({
                year: year,
                income: income,
                costs: costs
            });
        });
        
        // Send updates to server
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('update_entries', '1');
        formData.append('updates', JSON.stringify(updates));
        
        fetch(window.location.href, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Redirect to results page after successful save
                window.location.href = '{% url "results" %}';
            } else {
                alert('Error saving changes: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error saving changes. Please try again.');
        });
        });
    }

    // Clear form data for new users
    function clearFormData() {
        startYearEl.value = '';
        yearsCountEl.value = '';
        baseIncomeEl.value = '';
        growthEl.value = '';
        document.getElementById('housing_spending').value = '30';
        document.getElementById('travel_spending').value = '10';
        document.getElementById('food_spending').value = '15';
        document.getElementById('leisure_spending').value = '10';
        locationContainer.innerHTML = '';
        addLocationRow();
        updateYearValidation();
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        // Setup spending total calculation
        setupSpendingTotalCalculation();
        
        // Check button state on page load
        updateYearValidation();
        
        // Restore mode selection from localStorage if no saved data from database
        {% if not has_saved_data %}
            const savedMode = localStorage.getItem('selectedSpendingMode');
            if (savedMode) {
                const mode = parseInt(savedMode);
                if (mode === 1 || mode === 2) {
                    selectMode(mode);
                }
            }
        {% endif %}
        
        // Check if user has saved data in database
        {% if has_saved_data %}
            // Load saved data from database
            loadSavedDataFromDatabase();
            if (locationContainer.querySelectorAll('.location-row').length === 0) {
                addLocationRow();
            }
            updateYearValidation();
            // Enable View Results button if results already exist
            const viewResultsBtn = document.getElementById('viewResultsBtn');
            const viewResultsBtnActive = document.getElementById('viewResultsBtnActive');
            if (viewResultsBtn && viewResultsBtnActive) {
                viewResultsBtn.style.display = 'none';
                viewResultsBtnActive.style.display = 'inline-block';
            }
        {% else %}
            // New user - start with empty form
            clearFormData();
            // Update total after clearing
            updateSpendingTotal();
        {% endif %}

        {% if entries_data_json %}
            try {
                const existingEntries = JSON.parse('{{ entries_data_json|escapejs }}');
                if (existingEntries && existingEntries.length > 0) {
                    // Use saved spending mode to display correct table
                    const savedSpendingMode = '{{ spending_mode|default:"percentage_based" }}';
                    
                    // Set selectedMode FIRST based on saved preference, then display table
                    if (savedSpendingMode === 'location_based') {
                        selectedMode = 1;
                        document.getElementById('mode1').checked = true;
                        document.getElementById('modeOption1').classList.add('selected');
                        document.getElementById('modeOption1').style.borderColor = '#3b82f6';
                        document.getElementById('modeOption1').style.backgroundColor = '#eff6ff';
                        document.getElementById('option1Section').style.display = 'block';
                        document.getElementById('option2Section').style.display = 'none';
                        localStorage.setItem('selectedSpendingMode', '1');
                    } else {
                        selectedMode = 2;
                        document.getElementById('mode2').checked = true;
                        document.getElementById('modeOption2').classList.add('selected');
                        document.getElementById('modeOption2').style.borderColor = '#3b82f6';
                        document.getElementById('modeOption2').style.backgroundColor = '#eff6ff';
                        document.getElementById('option1Section').style.display = 'none';
                        document.getElementById('option2Section').style.display = 'block';
                        localStorage.setItem('selectedSpendingMode', '2');
                    }
                    
                    // Now display the table with the correct mode (this will show location column for Option 1, no location for Option 2)
                    displayResultsTable(existingEntries, savedSpendingMode);
                    
                    // Enable View Results button if entries exist
                    const viewResultsBtn = document.getElementById('viewResultsBtn');
                    const viewResultsBtnActive = document.getElementById('viewResultsBtnActive');
                    if (viewResultsBtn && viewResultsBtnActive) {
                        viewResultsBtn.style.display = 'none';
                        viewResultsBtnActive.style.display = 'inline-block';
                    }
                }
            } catch (e) {
                console.error('Error loading existing entries:', e);
            }
        {% endif %}
        
        // Set up auto-save for form fields
        setupFormAutoSave();
        
        // Auto-save table data when navigating away
        window.addEventListener('beforeunload', function() {
            // Save any pending table edits before leaving
            const incomeInputs = document.querySelectorAll('.editable-income');
            if (incomeInputs.length > 0) {
                const updates = [];
                incomeInputs.forEach(input => {
                    const year = parseInt(input.dataset.year);
                    const income = parseFloat(input.value.replace(/,/g, '')) || parseFloat(input.dataset.numericValue) || 0;
                    const costsInput = document.querySelector(`.editable-costs[data-year="${year}"]`);
                    const costs = parseFloat(costsInput.value.replace(/,/g, '')) || parseFloat(costsInput.dataset.numericValue) || 0;
                    
                    updates.push({
                        year: year,
                        income: income,
                        costs: costs
                    });
                });
                
                if (updates.length > 0) {
                    // Use sendBeacon for reliable saving on page unload
                    const formData = new FormData();
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
                    if (csrfToken) {
                        formData.append('csrfmiddlewaretoken', csrfToken);
                        formData.append('update_entries', '1');
                        formData.append('updates', JSON.stringify(updates));
                        
                        // Use sendBeacon if available, otherwise use fetch with keepalive
                        if (navigator.sendBeacon) {
                            const blob = new Blob([JSON.stringify({
                                csrfmiddlewaretoken: csrfToken,
                                update_entries: '1',
                                updates: JSON.stringify(updates)
                            })], { type: 'application/json' });
                            navigator.sendBeacon(window.location.href, blob);
                        } else {
                            fetch(window.location.href, {
                                method: 'POST',
                                body: formData,
                                keepalive: true
                            }).catch(() => {});
                        }
                    }
                }
            }
        });
    });
    </script>
</body>
</html>