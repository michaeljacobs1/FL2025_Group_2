{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projected Income/Results - {{ user.username }}</title>
    <link rel="stylesheet" href="{% static 'styles.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-brand">Financial Planner</h1>
            <div class="nav-links">
                <a href="{% url 'financial_dashboard' %}" class="nav-link">Home</a>
                <a href="{% url 'personal_info' %}" class="nav-link">Personal Info</a>
                <a href="{% url 'financial_info' %}" class="nav-link">Financial Info</a>
                <a href="{% url 'results' %}" class="nav-link active">Results</a>
                <a href="{% url 'monte_carlo_simulation' %}" class="nav-link">Monte Carlo</a>
                <form method="post" action="{% url 'logout' %}" class="logout-form">
                    {% csrf_token %}
                    <button type="submit" class="logout-btn">Logout</button>
                </form>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <div class="page-header">
                <h2>Your Financial Projection</h2>
                <p>View your projected income, costs, and savings over time with interactive charts and detailed breakdowns.</p>
            </div>

            {% if messages %}
                <div class="messages">
                    {% for message in messages %}
                        <div class="message message-{{ message.tags }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}

            <!-- Income and Costs Overview -->
            {% if income_entries %}
            <div class="results-section">
                <div class="card form-card">
                    <div class="card-header">
                        <h3>Income & Cost Analysis</h3>
                        <div class="form-toolbar">
                            <span class="pill">Income vs Costs</span>
                        </div>
                    </div>
                    <div class="card-content">
                <div class="chart-container">
                    <canvas id="incomeCostsChart" width="400" height="200"></canvas>
                </div>
                <div class="location-legend" id="locationLegend">
                    <!-- Location legend will be populated by JavaScript -->
                </div>
                
                <!-- Context Section -->
                <div class="context-section" style="margin-top: 2rem; border-top: 1px solid #e5e7eb; padding-top: 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; color: #1f2937;">Provide Context (Optional)</h4>
                    <p style="color: #6b7280; font-size: 0.9rem; margin-bottom: 1rem;">
                        Help the AI understand your situation better by providing context about your job, career, or any factors that explain your income trajectory. This will make the analysis more personalized and relevant.
                    </p>
                    <div class="field" style="margin-bottom: 1rem;">
                        <label for="incomeContext" style="display: block; margin-bottom: 0.5rem; color: #374151; font-weight: 500;">
                            Context about your income (e.g., job title, career stage, expected promotions, industry, etc.)
                        </label>
                        <textarea 
                            id="incomeContext" 
                            name="income_context" 
                            rows="4" 
                            placeholder="Example: I'm a software engineer in my mid-career. I expect steady salary increases of 5-8% annually as I gain seniority. I'm planning to transition to a senior role in 2-3 years which should increase my income by 30-40%."
                            style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-family: inherit; font-size: 0.9rem; resize: vertical; min-height: 100px;"
                        ></textarea>
                        <small style="display: block; margin-top: 0.5rem; color: #6b7280; font-size: 0.85rem;">
                            This information will be used to provide more contextual and personalized financial analysis.
                        </small>
                    </div>
                </div>
                
                <!-- AI Opinion Section -->
                <div class="ai-opinion-section" style="margin-top: 2rem; border-top: 1px solid #e5e7eb; padding-top: 1.5rem;">
                    {% csrf_token %}
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="margin: 0; color: #1f2937;">Get AI Opinion</h4>
                        <button type="button" id="getAIOpinionBtn" class="btn-primary" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-robot"></i>
                            Get AI Analysis
                        </button>
                    </div>
                    <p style="color: #6b7280; font-size: 0.9rem; margin-bottom: 1rem;">
                        Get an AI-powered analysis of your income and costs over time, including trends, insights, and recommendations.
                    </p>
                    
                    <!-- Loading indicator -->
                    <div id="aiLoadingIndicator" style="display: none; padding: 1rem; background: #f3f4f6; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div class="spinner" style="border: 3px solid #e5e7eb; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite;"></div>
                            <span style="color: #4b5563;">Analyzing your financial data...</span>
                        </div>
                    </div>
                    
                    <!-- Error message -->
                    <div id="aiErrorMessage" style="display: none; padding: 1rem; background: #fef2f2; border: 1px solid #fecaca; border-radius: 0.5rem; color: #991b1b; margin-bottom: 1rem;"></div>
                    
                    <!-- AI Analysis Result -->
                    <div id="aiAnalysisResult" style="display: none; padding: 1.5rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-top: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h5 style="margin: 0; color: #1f2937; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-brain" style="color: #3b82f6;"></i>
                                AI Analysis
                            </h5>
                            <button type="button" id="closeAIAnalysisBtn" style="background: none; border: none; color: #6b7280; cursor: pointer; font-size: 1.25rem; padding: 0.25rem 0.5rem;" title="Close">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="aiAnalysisContent" style="color: #374151; line-height: 1.6; white-space: pre-wrap;"></div>
                    </div>
                </div>
                            </div>
                            </div>

                </div>

            <!-- Net Worth Projection -->
            {% if income_entries %}
            <div class="results-section">
                <div class="card form-card">
                    <div class="card-header">
                        <h3>Net Worth Projection</h3>
                        <div class="form-toolbar">
                            <span class="pill">Investment Growth</span>
                                    </div>
                                    </div>
                    <div class="card-content">
                        <div class="chart-container">
                            <canvas id="netWorthProjectionChart" width="400" height="200"></canvas>
                                    </div>
                        <p class="chart-description" style="margin-top: 1rem; color: #6b7280; font-size: 0.875rem;">
                            Shows cumulative net worth assuming your net savings are invested with annual returns. Net worth grows from previous year's value plus returns, then adds that year's net savings.
                        </p>
                                    </div>
                                    </div>
                                </div>
            {% endif %}
            {% else %}
            <div class="results-section">
                <div class="card form-card">
                    <div class="card-content">
                        <div class="empty-state">
                            <h3>No Financial Data Found</h3>
                            <p>Please go to the Financial Info page to enter your income and spending preferences, then generate your projection.</p>
                            <a href="{% url 'financial_info' %}" class="btn-primary">Go to Financial Info</a>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}

                <!-- AI Cost Estimates Section -->
                {% if ai_cost_estimates %}
                <div class="card">
                    <div class="card-header">
                        <h3>AI-Generated Cost Estimates</h3>
                        <div class="form-toolbar">
                            <span class="pill">Location-based Analysis</span>
                        </div>
                    </div>
                    <div class="card-content">
                        {% for estimate in ai_cost_estimates %}
                        <div class="cost-estimate-card">
                            <div class="estimate-header">
                                <h4>{{ estimate.desired_location }}</h4>
                                <div class="estimate-meta">
                                    <span class="badge confidence-{% if estimate.confidence_score >= 0.8 %}5{% elif estimate.confidence_score >= 0.6 %}4{% elif estimate.confidence_score >= 0.4 %}3{% elif estimate.confidence_score >= 0.2 %}2{% else %}1{% endif %}">
                                        {{ estimate.confidence_score|floatformat:1 }}% confidence
                                    </span>
                                    <small>{{ estimate.created_at|date:"M d, Y" }}</small>
                                </div>
                            </div>
                            
                            <div class="estimate-details">
                                <div class="detail-row">
                                    <span class="detail-label">{{ estimate.get_house_type_display }}</span>
                                    <span class="detail-value">{{ estimate.house_size_sqft }} sq ft</span>
                        </div>
                                <div class="detail-row">
                                    <span class="detail-label">Children</span>
                                    <span class="detail-value">{{ estimate.number_of_children }}</span>
                    </div>
                </div>

                            <div class="cost-breakdown">
                                <div class="cost-category">
                                    <h5>Housing Costs (Annual)</h5>
                                    <div class="cost-items">
                                        <div class="cost-item">
                                            <span>Home Price:</span>
                                            <span class="money">${{ estimate.estimated_home_price|floatformat:0 }}</span>
                                        </div>
                                        <div class="cost-item">
                                            <span>Monthly Mortgage:</span>
                                            <span class="money">${{ estimate.estimated_monthly_mortgage|floatformat:0 }}</span>
                                        </div>
                                        <div class="cost-item">
                                            <span>Property Tax:</span>
                                            <span class="money">${{ estimate.estimated_property_tax_annual|floatformat:0 }}</span>
                                        </div>
                                        <div class="cost-item">
                                            <span>Insurance:</span>
                                            <span class="money">${{ estimate.estimated_insurance_annual|floatformat:0 }}</span>
                                        </div>
                                        <div class="cost-item">
                                            <span>Utilities:</span>
                                            <span class="money">${{ estimate.estimated_utilities_monthly|floatformat:0 }}/month</span>
                                        </div>
                                        <div class="cost-item">
                                            <span>Maintenance:</span>
                                            <span class="money">${{ estimate.estimated_maintenance_annual|floatformat:0 }}</span>
                                        </div>
                                    </div>
                                    {% if estimate.total_housing_costs_annual %}
                                    <div class="cost-total">
                                        <strong>Total Housing: ${{ estimate.total_housing_costs_annual|floatformat:0 }}/year</strong>
                                    </div>
                                    {% endif %}
                                </div>

                                {% if estimate.number_of_children > 0 %}
                                <div class="cost-category">
                                    <h5>Child Costs (Annual per Child)</h5>
                                    <div class="cost-items">
                                        <div class="cost-item">
                                            <span>Childcare:</span>
                                            <span class="money">${{ estimate.estimated_childcare_annual|floatformat:0 }}</span>
                                        </div>
                                        <div class="cost-item">
                                            <span>Education:</span>
                                            <span class="money">${{ estimate.estimated_education_annual|floatformat:0 }}</span>
                                        </div>
                                        <div class="cost-item">
                                            <span>Healthcare:</span>
                                            <span class="money">${{ estimate.estimated_child_healthcare_annual|floatformat:0 }}</span>
                                        </div>
                                        <div class="cost-item">
                                            <span>Food:</span>
                                            <span class="money">${{ estimate.estimated_child_food_annual|floatformat:0 }}</span>
                                        </div>
                                        <div class="cost-item">
                                            <span>Clothing:</span>
                                            <span class="money">${{ estimate.estimated_child_clothing_annual|floatformat:0 }}</span>
                                        </div>
                                    </div>
                                    {% if estimate.total_child_costs_annual %}
                                    <div class="cost-total">
                                        <strong>Total Child Costs: ${{ estimate.total_child_costs_annual|floatformat:0 }}/year</strong>
                                    </div>
                                    {% endif %}
                        </div>
                        {% endif %}

                                <div class="cost-category">
                                    <h5>Lifestyle Costs (Annual)</h5>
                                    <div class="cost-items">
                                        <div class="cost-item">
                                            <span>Transportation:</span>
                                            <span class="money">${{ estimate.estimated_transportation_annual|floatformat:0 }}</span>
                                        </div>
                                        <div class="cost-item">
                                            <span>Healthcare:</span>
                                            <span class="money">${{ estimate.estimated_healthcare_annual|floatformat:0 }}</span>
                                        </div>
                                        <div class="cost-item">
                                            <span>Groceries:</span>
                                            <span class="money">${{ estimate.estimated_groceries_annual|floatformat:0 }}</span>
                                        </div>
                                    </div>
                                    {% if estimate.total_lifestyle_costs_annual %}
                                    <div class="cost-total">
                                        <strong>Total Lifestyle: ${{ estimate.total_lifestyle_costs_annual|floatformat:0 }}/year</strong>
                                    </div>
                        {% endif %}
                    </div>
                </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="navigation-actions">
                <div class="action-buttons">
                    <a href="{% url 'financial_dashboard' %}" class="btn-secondary">Home</a>
                    <a href="{% url 'financial_info' %}" class="btn-primary">Update Financial Info</a>
                </div>
            </div>
        </div>
    </main>

    <script>
        (function(){
            // Money formatting
            document.querySelectorAll(".money").forEach(el=>{
                const raw = parseFloat(el.getAttribute("data-value") || "0");
                el.textContent = isNaN(raw) ? '$0.00' :
                    '$' + raw.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            });

        })();

           
            {% if income_entries %}
            const incomeData = [
                {% for entry in income_entries %}
                { year: {{ entry.year }}, income: {{ entry.after_tax_income }}, gross_income: {{ entry.income }}, costs: {{ entry.costs|default:0 }}, location: "{{ entry.location }}" },
                {% endfor %}
            ];

            const years = incomeData.map(entry => entry.year);
            const incomes = incomeData.map(entry => entry.income);
            const costs = incomeData.map(entry => entry.costs);
            const savings = incomes.map((income, i) => income - costs[i]);

            // Group data by location for separate datasets
            const locationGroups = {};
            incomeData.forEach(entry => {
                if (!locationGroups[entry.location]) {
                    locationGroups[entry.location] = [];
                }
                locationGroups[entry.location].push(entry);
            });

            // Sort locations by first occurrence
            const sortedLocations = Object.keys(locationGroups).sort((a, b) => {
                return Math.min(...locationGroups[a].map(e => e.year)) - Math.min(...locationGroups[b].map(e => e.year));
            });

            // Create datasets - one for each location
            const datasets = [];
            const incomeColor = '#3b82f6'; 
            const costsColor = '#ef4444';  

            sortedLocations.forEach((location, index) => {
                const group = locationGroups[location];
                const years = group.map(entry => entry.year);
                const incomes = group.map(entry => entry.income);
                const costs = group.map(entry => entry.costs);
                
                // Create data arrays with nulls for gaps
                const incomeDataArray = new Array(incomeData.length).fill(null);
                const costsDataArray = new Array(incomeData.length).fill(null);
                
                group.forEach(entry => {
                    const dataIndex = incomeData.findIndex(e => e.year === entry.year);
                    if (dataIndex !== -1) {
                        incomeDataArray[dataIndex] = entry.income;
                        costsDataArray[dataIndex] = entry.costs;
                    }
                });

                // Handle location label - if "N/A", don't include location in label
                const isPercentageBased = location === "N/A" || location === "Unknown";
                const incomeLabel = isPercentageBased ? "Income" : `Income - ${location}`;
                const costsLabel = isPercentageBased ? "Costs" : `Costs - ${location}`;

                datasets.push({
                    label: incomeLabel,
                    data: incomeDataArray,
                    borderColor: incomeColor,
                    backgroundColor: incomeColor + '20',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6
                });
                
                datasets.push({
                    label: costsLabel,
                    data: costsDataArray,
                    borderColor: costsColor,
                    backgroundColor: costsColor + '20',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6
                });
            });

            if (document.getElementById('incomeCostsChart')) {
                const ctx = document.getElementById('incomeCostsChart').getContext('2d');

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: years,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    boxWidth: 12,
                                    padding: 10
                                }
                            },
                            title: {
                                display: true,
                                text: sortedLocations.some(loc => loc === "N/A" || loc === "Unknown") 
                                    ? 'After-Tax Income vs Costs Over Time' 
                                    : 'After-Tax Income vs Costs Over Time by Location',
                                font: { size: 16 }
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const value = Number(context.parsed.y || 0);
                                        const entry = incomeData[context.dataIndex];
                                        const location = entry.location;
                                        const isPercentageBased = location === "N/A" || location === "Unknown";
                                        
                                        if (context.dataset.label.includes('Costs')) {
                                            if (isPercentageBased) {
                                                return context.dataset.label + ': $' + value.toLocaleString(undefined, {maximumFractionDigits: 0}) + ' (Percentage-based calculation)';
                                            } else {
                                                return context.dataset.label + ': $' + value.toLocaleString(undefined, {maximumFractionDigits: 0}) + ` (${location}, includes 3% annual increase)`;
                                            }
                                        } else {
                                            // Income is after-tax
                                            const gross = entry.gross_income || value;
                                            if (isPercentageBased) {
                                                return context.dataset.label + ': $' + value.toLocaleString(undefined, {maximumFractionDigits: 0}) + ' (After Tax)';
                                            } else {
                                                return context.dataset.label + ': $' + value.toLocaleString(undefined, {maximumFractionDigits: 0}) + ` (After Tax, ${location})`;
                                            }
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Year' },
                                grid: { display: false }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (v) => '$' + Number(v).toLocaleString(),
                                    maxTicksLimit: 8
                                },
                                title: { display: true, text: 'Amount ($)' },
                                grid: { color: 'rgba(0, 0, 0, 0.1)' }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });

                // Create simple location legend
                const legendContainer = document.getElementById('locationLegend');
                if (legendContainer) {
                    // Filter out "N/A" locations for the legend
                    const validLocations = sortedLocations.filter(loc => loc !== "N/A" && loc !== "Unknown");
                    const hasPercentageBased = sortedLocations.some(loc => loc === "N/A" || loc === "Unknown");
                    
                    let legendHTML = '<div class="location-legend-content">';
                    
                    if (validLocations.length > 0) {
                        legendHTML += '<h4>Location Timeline:</h4><div class="legend-items">';
                        validLocations.forEach((location, index) => {
                            const years = locationGroups[location].map(e => e.year).sort((a, b) => a - b);
                            const yearRange = years.length > 1 ? `${years[0]}-${years[years.length-1]}` : years[0];
                            legendHTML += `<div class="legend-item">
                                <span class="legend-text">${location} (${yearRange})</span>
                            </div>`;
                        });
                        legendHTML += '</div>';
                    }
                    
                    if (hasPercentageBased) {
                        if (validLocations.length > 0) {
                            legendHTML += '<div class="legend-items" style="margin-top: 0.5rem;">';
                        } else {
                            legendHTML += '<h4>Calculation Method:</h4><div class="legend-items">';
                        }
                        legendHTML += '<div class="legend-item"><span class="legend-text">Percentage-Based Calculation (No location adjustments)</span></div></div>';
                    }
                    
                    const noteText = hasPercentageBased 
                        ? 'Blue lines = After-Tax Income, Red dashed lines = Costs (Percentage-based, no annual increase applied)'
                        : 'Blue lines = After-Tax Income, Red dashed lines = Costs (not adjusted by taxes, increases 3% annually)';
                    legendHTML += `<div class="legend-note">${noteText}</div></div>`;
                    legendContainer.innerHTML = legendHTML;
                }
            }

            function generateVaryingReturns(numYears, targetCAGR, variationRange = 0.10) {
                
                const returns = [];
                              
                for (let i = 0; i < numYears; i++) {
                    
                    const variation = (Math.random() - 0.5) * variationRange;
                    const annualReturn = targetCAGR + variation;
                    
                    returns.push(Math.max(annualReturn, -0.30));
                }
                
                // Calculate geometric mean of generated returns
                const product = returns.reduce((acc, r) => acc * (1 + r), 1);
                const actualCAGR = Math.pow(product, 1 / numYears) - 1;
                
             
                // So: (1+ri_adjusted) = (1+ri) * ((1+targetCAGR)/(1+actualCAGR))
                const adjustmentFactor = (1 + targetCAGR) / (1 + actualCAGR);
                const adjustedReturns = returns.map(r => ((1 + r) * adjustmentFactor) - 1);
                
                // Verify the geometric mean
                const adjustedProduct = adjustedReturns.reduce((acc, r) => acc * (1 + r), 1);
                const verifiedCAGR = Math.pow(adjustedProduct, 1 / numYears) - 1;
                
                return adjustedReturns;
            }

            function calculateNetWorth(savings, targetCAGR) {
                const netWorthSeries = [];
                let currentNetWorth = 0;
                
                // Generate varying annual returns that maintain the target CAGR
                const annualReturns = generateVaryingReturns(savings.length, targetCAGR);
                
                for (let i = 0; i < savings.length; i++) {
                    
                    if (i === 0) {
                        currentNetWorth = savings[i];
                    } else {
                        
                        currentNetWorth = (currentNetWorth * (1 + annualReturns[i])) + savings[i];
                    }
                    netWorthSeries.push(currentNetWorth);
                }
                
                return { netWorth: netWorthSeries, returns: annualReturns };
            }

            const netSavings = savings; 
            const yearsLabels = years.map(y => String(y));

            // Calculate net worth for each scenario with varying returns
            const aggressiveResult = calculateNetWorth(netSavings, 0.10); 
            const moderateResult = calculateNetWorth(netSavings, 0.07);  
            const conservativeResult = calculateNetWorth(netSavings, 0.04); 
            
            const aggressiveNetWorth = aggressiveResult.netWorth;
            const moderateNetWorth = moderateResult.netWorth;
            const conservativeNetWorth = conservativeResult.netWorth;

            if (document.getElementById('netWorthProjectionChart')) {
                const ctxNW = document.getElementById('netWorthProjectionChart').getContext('2d');

                new Chart(ctxNW, {
                    type: 'line',
                    data: {
                        labels: yearsLabels,
                        datasets: [
                            {
                                label: 'Aggressive (10% annual return)',
                                data: aggressiveNetWorth,
                                borderColor: '#10b981', 
                                backgroundColor: '#10b98120',
                                borderWidth: 3,
                                fill: false,
                                tension: 0.4,
                                pointRadius: 4,
                                pointHoverRadius: 6
                            },
                            {
                                label: 'Moderate (7% annual return)',
                                data: moderateNetWorth,
                                borderColor: '#3b82f6', 
                                backgroundColor: '#3b82f620',
                                borderWidth: 3,
                                fill: false,
                                tension: 0.4,
                                pointRadius: 4,
                                pointHoverRadius: 6
                            },
                            {
                                label: 'Conservative (4% annual return)',
                                data: conservativeNetWorth,
                                borderColor: '#f59e0b', 
                                backgroundColor: '#f59e0b20',
                                borderWidth: 3,
                            fill: false,
                                tension: 0.4,
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            title: {
                                display: true,
                                text: 'Net Worth Projection Over Time',
                                font: { size: 16 }
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const value = Number(context.parsed.y || 0);
                                        return context.dataset.label + ': $' + value.toLocaleString(undefined, {
                                            maximumFractionDigits: 0,
                                            minimumFractionDigits: 0
                                        });
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Year' },
                                grid: { display: false }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (v) => '$' + Number(v).toLocaleString(),
                                    maxTicksLimit: 8
                                },
                                title: { display: true, text: 'Net Worth ($)' },
                                grid: { color: 'rgba(0, 0, 0, 0.1)' }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });
            }
            {% endif %}
            
            // AI Opinion functionality
            const getAIOpinionBtn = document.getElementById('getAIOpinionBtn');
            const aiLoadingIndicator = document.getElementById('aiLoadingIndicator');
            const aiErrorMessage = document.getElementById('aiErrorMessage');
            const aiAnalysisResult = document.getElementById('aiAnalysisResult');
            const aiAnalysisContent = document.getElementById('aiAnalysisContent');
            const closeAIAnalysisBtn = document.getElementById('closeAIAnalysisBtn');
            
            // Helper to strip markdown formatting
            function stripMarkdown(text) {
                if (!text) return text;
                return text
                    .replace(/\*\*(.*?)\*\*/g, '$1')  // Remove **bold**
                    .replace(/\*(.*?)\*/g, '$1')      // Remove *italic*
                    .replace(/##+\s*(.*?)(?:\n|$)/g, '$1\n')  // Remove ## headers
                    .replace(/#+\s*(.*?)(?:\n|$)/g, '$1\n')   // Remove # headers
                    .replace(/`(.*?)`/g, '$1');       // Remove `code`
            }
            
            // Helper to get CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            if (getAIOpinionBtn) {
                getAIOpinionBtn.addEventListener('click', function() {
                    // Hide previous results/errors
                    if (aiAnalysisResult) aiAnalysisResult.style.display = 'none';
                    if (aiErrorMessage) aiErrorMessage.style.display = 'none';
                    
                    // Show loading indicator
                    if (aiLoadingIndicator) aiLoadingIndicator.style.display = 'block';
                    getAIOpinionBtn.disabled = true;
                    getAIOpinionBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
                    
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                                     document.querySelector('input[name="csrfmiddlewaretoken"]')?.value ||
                                     getCookie('csrftoken') ||
                                     '';
                    
                    if (!csrfToken) {
                        console.error('CSRF token not found');
                        if (aiLoadingIndicator) aiLoadingIndicator.style.display = 'none';
                        getAIOpinionBtn.disabled = false;
                        getAIOpinionBtn.innerHTML = '<i class="fas fa-robot"></i> Get AI Analysis';
                        if (aiErrorMessage) {
                            aiErrorMessage.textContent = 'CSRF token not found. Please refresh the page and try again.';
                            aiErrorMessage.style.display = 'block';
                        }
                        return;
                    }
                    
                    // Get context input
                    const incomeContextInput = document.getElementById('incomeContext');
                    const incomeContext = incomeContextInput ? incomeContextInput.value.trim() : '';
                    
                    // Prepare form data
                    const formData = new FormData();
                    formData.append('csrfmiddlewaretoken', csrfToken);
                    formData.append('get_ai_opinion', '1');
                    if (incomeContext) {
                        formData.append('income_context', incomeContext);
                    }
                    
                    // Make request with proper headers
                    fetch(window.location.href, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                        },
                        body: formData,
                        credentials: 'same-origin'
                    })
                    .then(response => {
                        // Check if response is HTML (error page) instead of JSON
                        const contentType = response.headers.get('content-type') || '';
                        if (contentType.includes('text/html')) {
                            return response.text().then(html => {
                                console.error('Received HTML instead of JSON. Status:', response.status);
                                let errorMsg = 'Server returned an error page. ';
                                if (response.status === 403) {
                                    errorMsg += 'CSRF token validation failed. Please refresh the page and try again.';
                                } else if (response.status === 401 || response.status === 302) {
                                    errorMsg += 'Authentication required. Please log in again.';
                                } else {
                                    errorMsg += `HTTP ${response.status}. Check browser console for details.`;
                                }
                                throw new Error(errorMsg);
                            });
                        }
                        
                        if (!response.ok) {
                            return response.text().then(text => {
                                try {
                                    const json = JSON.parse(text);
                                    throw new Error(json.error || `HTTP ${response.status} error`);
                                } catch (e) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Hide loading indicator
                        if (aiLoadingIndicator) aiLoadingIndicator.style.display = 'none';
                        getAIOpinionBtn.disabled = false;
                        getAIOpinionBtn.innerHTML = '<i class="fas fa-robot"></i> Get AI Analysis';
                        
                        if (data.success) {
                            // Display analysis (strip markdown)
                            if (aiAnalysisContent && aiAnalysisResult) {
                                const cleanedAnalysis = stripMarkdown(data.analysis);
                                aiAnalysisContent.textContent = cleanedAnalysis;
                                aiAnalysisResult.style.display = 'block';
                                
                                // Scroll to analysis
                                aiAnalysisResult.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            } else {
                                console.error('AI analysis elements not found in DOM');
                            }
                        } else {
                            // Display error
                            const errorMsg = data.error || 'Failed to generate AI analysis. Please try again.';
                            console.error('AI Analysis Error:', errorMsg);
                            if (aiErrorMessage) {
                                aiErrorMessage.textContent = errorMsg;
                                aiErrorMessage.style.display = 'block';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        if (aiLoadingIndicator) aiLoadingIndicator.style.display = 'none';
                        getAIOpinionBtn.disabled = false;
                        getAIOpinionBtn.innerHTML = '<i class="fas fa-robot"></i> Get AI Analysis';
                        const errorMsg = error.message || 'An error occurred while generating the analysis. Please check the browser console for details.';
                        if (aiErrorMessage) {
                            aiErrorMessage.textContent = errorMsg;
                            aiErrorMessage.style.display = 'block';
                        }
                    });
                });
            }
            
            // Close analysis button
            if (closeAIAnalysisBtn) {
                closeAIAnalysisBtn.addEventListener('click', function() {
                    if (aiAnalysisResult) aiAnalysisResult.style.display = 'none';
                });
            }
    </script>
</body>
</html>
