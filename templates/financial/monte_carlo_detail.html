{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monte Carlo Simulation Details - {{ user.username }}</title>
    <link rel="stylesheet" href="{% static 'styles.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-brand">Financial Planner</h1>
            <div class="nav-links">
                <a href="{% url 'financial_dashboard' %}" class="nav-link">Home</a>
                <a href="{% url 'personal_info' %}" class="nav-link">Personal Info</a>
                <a href="{% url 'financial_info' %}" class="nav-link">Financial Info</a>
                <a href="{% url 'results' %}" class="nav-link">Results</a>
                <a href="{% url 'monte_carlo_simulation' %}" class="nav-link active">Monte Carlo</a>
                <form method="post" action="{% url 'logout' %}" class="logout-form">
                    {% csrf_token %}
                    <button type="submit" class="logout-btn">Logout</button>
                </form>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <div class="page-header">
                <h2>Monte Carlo Simulation Results</h2>
                <p>Detailed analysis of your Monte Carlo simulation run on {{ simulation.created_at|date:"F d, Y g:i A" }}</p>
            </div>

            {% if messages %}
                <div class="messages">
                    {% for message in messages %}
                        <div class="message message-{{ message.tags }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}

            <!-- Simulation Parameters -->
            <div class="card form-card">
                <div class="card-header">
                    <h3>Simulation Parameters</h3>
                </div>
                <div class="card-content">
                    {% if is_likely_bootstrap %}
                    <div style="margin-bottom: 1rem; padding: 1rem; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-left: 4px solid #3b82f6; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.5rem;">ðŸ“Š</span>
                            <div>
                                <strong style="color: #1e40af; font-size: 1.1rem;">Historical Data Bootstrap Method</strong>
                                <p style="color: #1e3a8a; margin: 0.25rem 0 0 0; font-size: 0.9rem;">
                                    This simulation used empirical bootstrap sampling from real historical stock market and inflation data. 
                                    The distribution shows right-skewed characteristics typical of actual market returns.
                                </p>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div style="margin-bottom: 1rem; padding: 1rem; background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); border-left: 4px solid #6b7280; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.5rem;">ðŸ“ˆ</span>
                            <div>
                                <strong style="color: #374151; font-size: 1.1rem;">Normal Distribution Method</strong>
                                <p style="color: #4b5563; margin: 0.25rem 0 0 0; font-size: 0.9rem;">
                                    This simulation used normal distribution approximation for returns and inflation.
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    <div class="stats-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                        <div class="stat-item" style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); border-left: 4px solid #6366f1; padding: 1rem; border-radius: 8px;">
                            <label style="color: #4338ca; font-weight: 600; display: block; margin-bottom: 0.5rem;">Scenario:</label>
                            <span style="color: #3730a3; font-weight: 700; font-size: 1.125rem;">{{ simulation.scenario.name|default:"Custom" }}</span>
                        </div>
                        <div class="stat-item" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-left: 4px solid #3b82f6; padding: 1rem; border-radius: 8px;">
                            <label style="color: #1e40af; font-weight: 600; display: block; margin-bottom: 0.5rem;">Projected Years:</label>
                            <span style="color: #1e3a8a; font-weight: 700; font-size: 1.125rem;">{{ simulation.projected_years }}</span>
                        </div>
                        <div class="stat-item" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left: 4px solid #f59e0b; padding: 1rem; border-radius: 8px;">
                            <label style="color: #92400e; font-weight: 600; display: block; margin-bottom: 0.5rem;">Iterations:</label>
                            <span style="color: #78350f; font-weight: 700; font-size: 1.125rem;">{{ simulation.number_of_iterations|floatformat:0|intcomma }}</span>
                        </div>
                        <div class="stat-item" style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); border-left: 4px solid #22c55e; padding: 1rem; border-radius: 8px;">
                            <label style="color: #166534; font-weight: 600; display: block; margin-bottom: 0.5rem;">Base Return Rate:</label>
                            <span style="color: #14532d; font-weight: 700; font-size: 1.125rem;">{{ simulation.base_return_rate }}%</span>
                        </div>
                        <div class="stat-item" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-left: 4px solid #ef4444; padding: 1rem; border-radius: 8px;">
                            <label style="color: #991b1b; font-weight: 600; display: block; margin-bottom: 0.5rem;">Return Rate Std Dev:</label>
                            <span style="color: #7f1d1d; font-weight: 700; font-size: 1.125rem;">{{ simulation.return_rate_std_dev }}%</span>
                        </div>
                        <div class="stat-item" style="background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border-left: 4px solid #f59e0b; padding: 1rem; border-radius: 8px;">
                            <label style="color: #92400e; font-weight: 600; display: block; margin-bottom: 0.5rem;">Base Inflation Rate:</label>
                            <span style="color: #78350f; font-weight: 700; font-size: 1.125rem;">{{ simulation.base_inflation_rate }}%</span>
                        </div>
                    </div>
                    {% if simulation.target_goal %}
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #e2e8f0;">
                        <div class="stat-item" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-left: 4px solid #10b981; padding: 1rem; border-radius: 8px; max-width: 33%;">
                            <label style="color: #065f46; font-weight: 600; display: block; margin-bottom: 0.5rem;">Target Goal:</label>
                            <span style="color: #047857; font-weight: 700; font-size: 1.125rem;">${{ simulation.target_goal|floatformat:0|intcomma }}</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Summary Statistics -->
            <div class="card form-card">
                <div class="card-header">
                    <h3>Summary Statistics (Final Portfolio Value)</h3>
                </div>
                <div class="card-content">
                    <div class="stats-grid">
                        <div class="stat-item highlight" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-left: 4px solid #3b82f6;">
                            <label style="color: #1e40af;">Mean (Average):</label>
                            <span class="stat-value" style="color: #1e3a8a; font-weight: 700;">${{ simulation.mean_final_value|floatformat:2|intcomma }}</span>
                        </div>
                        <div class="stat-item highlight" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-left: 4px solid #22c55e;">
                            <label style="color: #166534;">Median (50th Percentile):</label>
                            <span class="stat-value" style="color: #14532d; font-weight: 700;">${{ simulation.median_final_value|floatformat:2|intcomma }}</span>
                        </div>
                        <div class="stat-item" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left: 4px solid #f59e0b;">
                            <label style="color: #92400e;">Standard Deviation:</label>
                            <span style="color: #78350f; font-weight: 600;">${{ simulation.std_dev_final_value|floatformat:2|intcomma }}</span>
                        </div>
                        <div class="stat-item" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-left: 4px solid #ef4444;">
                            <label style="color: #991b1b;">Minimum Value:</label>
                            <span style="color: #7f1d1d; font-weight: 600;">${{ simulation.min_final_value|floatformat:2|intcomma }}</span>
                        </div>
                        <div class="stat-item" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-left: 4px solid #10b981;">
                            <label style="color: #065f46;">Maximum Value:</label>
                            <span style="color: #047857; font-weight: 600;">${{ simulation.max_final_value|floatformat:2|intcomma }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Confidence Intervals / Percentiles -->
            <div class="card form-card">
                <div class="card-header">
                    <h3>Confidence Intervals (Percentiles)</h3>
                    <p style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem;">
                        These percentiles show the range of possible outcomes. For example, the 5th percentile means 
                        5% of simulations resulted in values at or below this amount (worst case).
                    </p>
                </div>
                <div class="card-content">
                    <div class="percentile-container">
                        <div class="percentile-item worst-case">
                            <div class="percentile-label">5th Percentile (Worst Case)</div>
                            <div class="percentile-value">${{ simulation.percentile_5|floatformat:2|intcomma }}</div>
                            <div class="percentile-description">5% of scenarios perform worse than this</div>
                        </div>
                        <div class="percentile-item conservative">
                            <div class="percentile-label">25th Percentile</div>
                            <div class="percentile-value">${{ simulation.percentile_25|floatformat:2|intcomma }}</div>
                            <div class="percentile-description">Conservative estimate</div>
                        </div>
                        <div class="percentile-item median">
                            <div class="percentile-label">50th Percentile (Median)</div>
                            <div class="percentile-value">${{ simulation.median_final_value|floatformat:2|intcomma }}</div>
                            <div class="percentile-description">Most likely outcome</div>
                        </div>
                        <div class="percentile-item optimistic">
                            <div class="percentile-label">75th Percentile</div>
                            <div class="percentile-value">${{ simulation.percentile_75|floatformat:2|intcomma }}</div>
                            <div class="percentile-description">Optimistic estimate</div>
                        </div>
                        <div class="percentile-item best-case">
                            <div class="percentile-label">95th Percentile (Best Case)</div>
                            <div class="percentile-value">${{ simulation.percentile_95|floatformat:2|intcomma }}</div>
                            <div class="percentile-description">5% of scenarios perform better than this</div>
                        </div>
                    </div>
                </div>
            </div>

            {% if simulation.target_goal %}
            <!-- Success Rate -->
            <div class="card form-card">
                <div class="card-header">
                    <h3>Goal Achievement Probability</h3>
                </div>
                <div class="card-content">
                    <div class="success-rate-display">
                        {% if simulation.success_rate >= 75 %}
                        <div class="success-rate-value" style="color: #059669; font-size: 3rem; font-weight: 800; text-shadow: 0 2px 4px rgba(5, 150, 105, 0.2);">{{ simulation.success_rate|floatformat:1 }}%</div>
                        {% elif simulation.success_rate >= 50 %}
                        <div class="success-rate-value" style="color: #f59e0b; font-size: 3rem; font-weight: 800; text-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);">{{ simulation.success_rate|floatformat:1 }}%</div>
                        {% else %}
                        <div class="success-rate-value" style="color: #dc2626; font-size: 3rem; font-weight: 800; text-shadow: 0 2px 4px rgba(220, 38, 38, 0.2);">{{ simulation.success_rate|floatformat:1 }}%</div>
                        {% endif %}
                        <p class="success-rate-description">
                            Probability of reaching your target goal of ${{ simulation.target_goal|floatformat:0|intcomma }}
                        </p>
                        <div class="success-rate-bar" style="background: #e5e7eb; border-radius: 10px; height: 30px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                            {% if simulation.success_rate >= 75 %}
                            <div class="success-rate-fill" style="width: {{ simulation.success_rate }}%; background: linear-gradient(90deg, #059669 0%, #10b981 50%, #34d399 100%); height: 100%; transition: width 1s ease; box-shadow: 0 2px 8px rgba(5, 150, 105, 0.4);"></div>
                            {% elif simulation.success_rate >= 50 %}
                            <div class="success-rate-fill" style="width: {{ simulation.success_rate }}%; background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 50%, #fcd34d 100%); height: 100%; transition: width 1s ease; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);"></div>
                            {% else %}
                            <div class="success-rate-fill" style="width: {{ simulation.success_rate }}%; background: linear-gradient(90deg, #dc2626 0%, #ef4444 50%, #f87171 100%); height: 100%; transition: width 1s ease; box-shadow: 0 2px 8px rgba(220, 38, 38, 0.4);"></div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Distribution Chart -->
            <div class="card form-card">
                <div class="card-header">
                    <h3>Distribution Visualization</h3>
                    <p style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem;">
                        {% if is_likely_bootstrap %}
                        Probability distribution showing right-skewed characteristics from historical bootstrap data
                        {% else %}
                        Probability distribution of final portfolio values (normal approximation)
                        {% endif %}
                        across all {{ simulation.number_of_iterations|floatformat:0 }} iterations
                    </p>
                </div>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="distributionChart" width="400" height="200"></canvas>
                    </div>
                    {% if is_likely_bootstrap %}
                    <div style="margin-top: 1rem; padding: 1rem; background: #f0f9ff; border-left: 4px solid #0ea5e9; border-radius: 6px;">
                        <p style="margin: 0; color: #0c4a6e; font-size: 0.9rem;">
                            <strong>ðŸ“Š Right-Skewed Distribution:</strong> The mean ({{ simulation.mean_final_value|floatformat:0|intcomma }}) 
                            is {{ skewness_ratio|floatformat:1 }}x the median ({{ simulation.median_final_value|floatformat:0|intcomma }}), 
                            indicating a long tail on the right. This is typical of stock market returns where occasional large gains 
                            pull the average higher than the typical outcome.
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Percentile Comparison Chart -->
            <div class="card form-card">
                <div class="card-header">
                    <h3>Percentile Comparison</h3>
                </div>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="percentileChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- Key Insights -->
            <div class="card form-card">
                <div class="card-header">
                    <h3>Key Insights</h3>
                </div>
                <div class="card-content">
                    <div class="insights-list">
                        <div class="insight-item">
                            <strong>Expected Outcome:</strong> 
                            The median (50th percentile) final value is ${{ simulation.median_final_value|floatformat:2|intcomma }}, 
                            meaning half of all simulations result in higher values and half in lower values.
                        </div>
                        <div class="insight-item">
                            <strong>Range of Outcomes:</strong> 
                            Your final portfolio value could range from ${{ simulation.percentile_5|floatformat:2|intcomma }} 
                            (worst case) to ${{ simulation.percentile_95|floatformat:2|intcomma }} (best case).
                        </div>
                        <div class="insight-item">
                            <strong>Risk Assessment:</strong> 
                            With a standard deviation of ${{ simulation.std_dev_final_value|floatformat:2|intcomma }}, 
                            there is significant variability in the outcomes.
                        </div>
                        {% if simulation.target_goal %}
                        <div class="insight-item">
                            <strong>Goal Achievement:</strong> 
                            {% if simulation.success_rate >= 75 %}
                            There's a high probability ({{ simulation.success_rate|floatformat:1 }}%) of reaching your goal. 
                            This is a good sign that your financial plan is on track.
                            {% elif simulation.success_rate >= 50 %}
                            There's a moderate probability ({{ simulation.success_rate|floatformat:1 }}%) of reaching your goal. 
                            Consider adjusting your savings rate or investment strategy to improve your odds.
                            {% else %}
                            The probability ({{ simulation.success_rate|floatformat:1 }}%) of reaching your goal is relatively low. 
                            Consider increasing your savings rate, extending your time horizon, or adjusting your investment strategy.
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>


            <div class="navigation-actions">
                <div class="action-buttons">
                    <a href="{% url 'monte_carlo_simulation' %}" class="btn-secondary">Back to Monte Carlo</a>
                    <a href="{% url 'results' %}" class="btn-secondary">Results</a>
                    <a href="{% url 'financial_dashboard' %}" class="btn-primary">Home</a>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Distribution Chart (Histogram)
        // Note: For a true histogram, we'd need the actual iteration data
        // For now, we'll show a simplified visualization using percentiles
        const percentileCtx = document.getElementById('percentileChart').getContext('2d');
        
        const percentileChart = new Chart(percentileCtx, {
            type: 'bar',
            data: {
                labels: ['5th', '25th', '50th (Median)', '75th', '95th'],
                datasets: [{
                    label: 'Final Portfolio Value',
                    data: [
                        {{ simulation.percentile_5|floatformat:0 }},
                        {{ simulation.percentile_25|floatformat:0 }},
                        {{ simulation.median_final_value|floatformat:0 }},
                        {{ simulation.percentile_75|floatformat:0 }},
                        {{ simulation.percentile_95|floatformat:0 }}
                    ],
                    backgroundColor: [
                        'rgba(239, 68, 68, 0.9)',   // Red for 5th
                        'rgba(251, 146, 60, 0.9)',  // Orange for 25th
                        'rgba(59, 130, 246, 0.9)',  // Blue for median
                        'rgba(34, 197, 94, 0.9)',   // Green for 75th
                        'rgba(16, 185, 129, 0.9)'   // Teal for 95th
                    ],
                    borderColor: [
                        '#dc2626',
                        '#ea580c',
                        '#2563eb',
                        '#16a34a',
                        '#059669'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Percentile Distribution of Final Values'
                    },
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });

        // Distribution Chart - Right-skewed or normal visualization
        const distCtx = document.getElementById('distributionChart').getContext('2d');
        
        const mean = {{ simulation.mean_final_value|floatformat:0 }};
        const stdDev = {{ simulation.std_dev_final_value|floatformat:0 }};
        const median = {{ simulation.median_final_value|floatformat:0 }};
        const min = {{ simulation.percentile_5|floatformat:0 }};
        const max = {{ simulation.percentile_95|floatformat:0 }};
        const skewRatio = {{ skewness_ratio|floatformat:2 }};
        
        // Since bootstrap is now the DEFAULT method, ALWAYS use bootstrap visualization
        // The simulation uses bootstrap by default, so always show right-skewed distribution
        const useBootstrapViz = true; // Bootstrap is the default method now
        
        // Get iteration data if available
        const iterationData = {{ iteration_values_json|safe }};
        
        let distributionChart;
        
        // Always use bootstrap visualization since it's the default method
        if (useBootstrapViz) {
            // Bootstrap method - show actual bootstrap results
            // Always prefer showing actual histogram from iteration data
            if (iterationData && iterationData.length > 0) {
                // Create histogram from actual iteration data
                // Use actual min/max from data to avoid binning artifacts at edges
                const actualMin = Math.min(...iterationData);
                const actualMax = Math.max(...iterationData);
                const dataRange = actualMax - actualMin;
                
                // Adaptive number of bins based on data size (but not too many)
                const numBins = Math.min(35, Math.max(25, Math.floor(Math.sqrt(iterationData.length))));
                const binWidth = dataRange / numBins;
                const bins = new Array(numBins).fill(0);
                const binLabels = [];
                
                // Count values in each bin with proper edge handling
                iterationData.forEach(value => {
                    // Calculate bin index (0 to numBins-1)
                    let binIndex = Math.floor((value - actualMin) / binWidth);
                    // Handle edge cases properly
                    // Values at exactly max should go in last bin, others should be clamped
                    if (binIndex >= numBins) {
                        binIndex = numBins - 1;
                    }
                    // Also handle case where value equals min (should go in first bin)
                    if (value === actualMin) {
                        binIndex = 0;
                    }
                    bins[binIndex]++;
                });
                
                // Create labels for bins (show midpoint of each bin for clarity)
                // Format labels: use millions if >= 1M, otherwise use thousands
                function formatLabel(value) {
                    if (value >= 1000000) {
                        return '$' + (value / 1000000).toFixed(1) + 'M';
                    } else {
                        return '$' + Math.round(value / 1000) + 'k';
                    }
                }
                
                for (let i = 0; i < numBins; i++) {
                    const binStart = actualMin + i * binWidth;
                    const binMidpoint = binStart + binWidth / 2;
                    // Only show every Nth label to avoid clutter
                    if (i === 0 || i === numBins - 1 || i % Math.ceil(numBins / 15) === 0) {
                        binLabels.push(formatLabel(binMidpoint));
                    } else {
                        binLabels.push('');
                    }
                }
                
                distributionChart = new Chart(distCtx, {
                    type: 'bar',
                    data: {
                        labels: binLabels,
                        datasets: [{
                            label: 'Frequency',
                            data: bins,
                            backgroundColor: 'rgba(16, 185, 129, 0.7)',
                            borderColor: '#10b981',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Right-Skewed Distribution from Historical Bootstrap Data',
                                font: { size: 15, weight: 'bold', color: '#059669' }
                            },
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: true,
                                displayColors: false,
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#10b981',
                                borderWidth: 1,
                                callbacks: {
                                    title: function(context) {
                                        // Show consistent title for all bars
                                        return 'Portfolio Value Range';
                                    },
                                    label: function(context) {
                                        const binStart = actualMin + context.dataIndex * binWidth;
                                        const binEnd = binStart + binWidth;
                                        
                                        // Format values: use millions if >= 1M, otherwise use thousands
                                        function formatValue(value) {
                                            if (value >= 1000000) {
                                                return '$' + (value / 1000000).toFixed(2) + 'M';
                                            } else {
                                                return '$' + Math.round(value / 1000) + 'k';
                                            }
                                        }
                                        
                                        const iterations = context.parsed.y;
                                        return [
                                            `Range: ${formatValue(binStart)} - ${formatValue(binEnd)}`,
                                            `Iterations: ${iterations}`
                                        ];
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Iterations'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Final Portfolio Value'
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
            } else {
                // No iteration data stored - show a note about this
                // In bootstrap mode, iterations should be stored for accurate visualization
                distributionChart = new Chart(distCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Note'],
                        datasets: [{
                            label: 'No Data',
                            data: [0],
                            backgroundColor: 'rgba(156, 163, 175, 0.5)'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Historical Bootstrap Results - Iteration Data Not Stored',
                                font: { size: 14, weight: 'bold', color: '#6b7280' }
                            },
                            legend: {
                                display: false
                            }
                        }
                    }
                });
                
                // Add a message to the page
                const chartContainer = document.querySelector('.chart-container');
                if (chartContainer) {
                    chartContainer.innerHTML += '<div style="margin-top: 1rem; padding: 1rem; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 6px;"><p style="margin: 0; color: #92400e;"><strong>Note:</strong> This simulation used historical bootstrap data, but iteration values were not stored. Percentiles shown are from actual bootstrap results. Enable "Store Iterations" option when running simulations to see the full distribution histogram.</p></div>';
                }
            }
        } else {
            // Normal distribution method
            const numPoints = 40;
            const samplePoints = [];
            const labels = [];
            
            for (let i = 0; i < numPoints; i++) {
                const value = min + (max - min) * (i / (numPoints - 1));
                labels.push('$' + Math.round(value/1000) + 'k');
                
                // Normal distribution (bell curve)
                const z = (value - mean) / stdDev;
                const density = Math.exp(-0.5 * z * z);
                samplePoints.push(density * 1000);
            }
            
            distributionChart = new Chart(distCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Probability Density',
                        data: samplePoints,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Normal Distribution (Normal Approximation Method)',
                            font: { size: 15, weight: 'bold', color: '#2563eb' }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Relative Probability'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Final Portfolio Value'
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
